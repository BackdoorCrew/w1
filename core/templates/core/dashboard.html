{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}
{% load l10n %}
{% block title %}Meu Painel - W1 Holding Platform{% endblock %}

{% block header %}
    <header class="dashboard-header">
        <div class="logo-container">
            <img src="{% static 'images/logo.png' %}" alt="W1 Logo">
            <h1>Holding</h1>
            
        </div>
        <div class="header-right" style="display: flex; flex-direction: row; margin-right: 50px;">
            <div class="search-container">
                <input type="text" class="search-bar" placeholder="Pesquisar...">
                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <span class="search-text">Buscar</span>
            </div>
            <div class="header-icons">
                <svg class="notification-icon" data-section="notificacoes" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" title="Notifica√ß√µes">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <svg class="settings-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" title="Configura√ß√µes">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l-.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </div>
        </div>
    </header>
{% endblock header %}

{% block head_extra_styles %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { background-color: #022028 !important; color: #e5e7eb; font-family: 'Montserrat', sans-serif; margin: 0; overflow-x: hidden; }
        .cal-sans-regular { font-family: "Cal Sans", sans-serif; font-weight: 400; font-style: normal; }
        .dashboard-header { background: #011A21; border-bottom: solid 1px #000; color: #fff; padding: 0px 20px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; width: 100%; z-index: 1050; height: 70px; }
        .logo-container { display: flex; align-items: baseline; gap: 10px; }
        .logo-container span { font-weight: bold; font-size: 1.5rem; margin-left: 100px; }
        .logo-container img { height: 35px; width: auto;}
        .logo-container h1 { font-family: "Montserrat", sans-serif; font-size: 1.5rem; font-weight: normal; margin: 0; color: #fff; }
        .search-container { display: flex; align-items: center; width: 280px; background: #044048; border: 1px solid #055058; border-radius: 4px; padding: 6px 10px; margin-right: 15px; }
        .search-bar { flex: 1; background: transparent; color: #d1d5db; border: none; outline: none; font-family: "Montserrat", sans-serif; font-size: 0.9rem; }
        .search-bar::placeholder { color: #6b7280; }
        .search-icon, .search-text { color: #d1d5db; margin-left: 8px; font-family: "Montserrat", sans-serif; }
        .search-text { font-size: 0.8rem; font-weight: bold; }
        .search-icon:hover, .search-text:hover, .notification-icon:hover, .settings-icon:hover { color: #5fded4; cursor: pointer; }
        .header-icons { display: flex; align-items: center; gap: 18px; }
        .header-icons svg { width: 22px; height: 22px; stroke: currentColor; }
        .dashboard-container { display: flex; background: #022028; padding-top: 70px; }
        .sidebar { width: 260px; background: #011a21; color: #fff; border-right: solid 1px #000; padding: 20px 0px 0px 0px; overflow-y: auto; height: calc(100vh - 70px); position: fixed; left: 0; top: 70px; z-index: 1000; }
        .sidebar ul { list-style-type: none; padding: 0; margin:0; }
        .sidebar-item { margin-bottom: 0px; border-radius: 0px; transition: background-color 0.2s ease; border-left: 3px solid transparent; }
        .sidebar-item:hover { background-color: #033038; }
        .sidebar-item a { color: #adb5bd; text-decoration: none; font-weight: 500; font-size: 0.95rem; font-family: "Montserrat", sans-serif; display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; transition: color 0.2s ease, border-left-color 0.2s ease; }
        .sidebar-item a:hover { color: #5fded4; }
        .sidebar-item.active { background-color: #044048; border-left-color: #5fded4; }
        .sidebar-item.active a { color: #5fded4; font-weight: 600; }
        .nav-icon-container { display: flex; align-items: center; gap: 12px; }
        .nav-icon-container svg { width: 18px; height: 18px; stroke: #adb5bd; fill:none; transition: stroke 0.2s ease; }
        .sidebar-item a:hover .nav-icon-container svg, .sidebar-item.active .nav-icon-container svg { stroke: #5fded4; }
        .sidebar-item a.logout-btn .nav-icon-container svg { stroke: #e57373; }
        .sidebar-item a.logout-btn:hover .nav-icon-container svg { stroke: #ef5350; }
        .main-content-wrapper { margin-left: 260px; width: calc(100% - 260px); background-color: #022028; padding: 25px; }
        .main-content { color: #fff; }
        .section { display: none;  background-color: #022028; padding: 0px; border-radius: 8px;  animation: fadeInContent 0.5s ease-out; }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section.active { display: block; }
        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem;padding-top: 20px; border-bottom: 1px solid #044048; }
        .section-header h2 { font-size: 1.75rem; color: #fff; font-family: "Cal Sans", sans-serif; margin: 0; display: flex; align-items:center; }
        .section-header .fas { font-size: 1.5rem; color: #5fded4; margin-right: 10px; } /* For Font Awesome icons */
        .section-header svg.title-icon { width: 24px; height: 24px; stroke: #fff; fill:none; margin-right: 10px; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .progress-list, .document-list-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .progress-card { background: #044048; border: 1px solid #055058; border-radius: 8px; padding: 16px; margin-bottom: 16px; display: flex; align-items: center; width: calc(45%); box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.3s ease; }
         @media (max-width: 1024px) { .progress-card { width: 100%; } }
        .progress-card:hover { transform: translateY(-2px); }
        .progress-icon { width: 40px; height: 40px; margin-right: 16px; flex-shrink: 0; }
        .progress-icon svg { width: 100%; height: 100%; stroke: #5fded4; fill: none; }
        .progress-card.incomplete .progress-icon svg { stroke: #fff; fill: none; }
        .progress-content { flex: 1; }
        .progress-title { font-size: 1.25rem; color: #5fded4; font-family: "Cal Sans", sans-serif; margin: 0 0 8px; }
        .progress-card.incomplete .progress-title { color: #fff; }
        .progress-description { font-size: 0.875rem; color: #d1d5db; font-family: "Montserrat", sans-serif; margin: 0 0 12px; }
        .progress-bar-container { background: #022028; border-radius: 4px; height: 8px; overflow: hidden; }
        .progress-bar { background: #5fded4; height: 100%; transition: width 0.3s ease; }
        .status-text { font-style: italic; font-size: 0.875rem; color: #d1d5db; }
        .status-text .fas, .progress-status .fas { color: #5fded4; } /* For Font Awesome icons */
        .status-text .text-green-400, .progress-status .text-green-400 { color: #34d399 !important; }
        .status-text .text-yellow-400, .progress-status .text-yellow-400 { color: #facc15 !important; }
        .status-text .text-blue-400, .progress-status .text-blue-400 { color: #60a5fa !important; } /* Added for 'Em Andamento' */
        .progress-status { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 0.875rem; color: #d1d5db; }
        .progress-status .status-icon { color: #5fded4; } /* For Font Awesome icons */
        .document-upload .upload-btn { display: inline-block; padding: 8px 16px; background-color: #5fded4; color: #022028; border-radius: 4px; font-weight: bold; font-family: "Montserrat", sans-serif; text-decoration: none; cursor: pointer; transition: background-color 0.3s ease; font-size: 0.85rem; }
        .document-upload .upload-btn:hover { background-color: #4acbc1; }

        .table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #044048; color: #d1d5db; border-radius: 8px; overflow: hidden; }
        .table th, .table td { border: 1px solid #055058; padding: 10px; text-align: left; font-family: "Montserrat", sans-serif; }
        .table th { background: #055058; color: #5fded4; }
        .table a { color: #5fded4; text-decoration: underline; }
        .table a:hover { color: #7aded5; }

        .sidebar-item a.logout-btn { background-color: transparent; color: #e57373; border: none; }
        .sidebar-item a.logout-btn:hover { background-color: rgba(227, 52, 52, 0.1); color: #ef5350; }
        .django-messages-container { padding: 0 0 15px 0; }
        .content-card { background-color: #032830; padding: 1.5rem; border-radius: 8px; border: 1px solid #044048; }
        .form-group-custom { margin-bottom: 1.5rem; }
        .form-group-custom label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #cbd5e1; font-size:0.9rem; }
        .form-control-custom { display: block; width: 100%; padding: .5rem .75rem; font-size: 1rem; font-weight: 400; line-height: 1.5; color: #cbd5e1; background-color: #044048; background-clip: padding-box; border: 1px solid #055058; -webkit-appearance: none; -moz-appearance: none; appearance: none; border-radius: .375rem; transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; }
        .form-control-custom:focus { color: #e5e7eb; background-color: #055058; border-color: #5fded4; outline: 0; box-shadow: 0 0 0 .2rem rgba(95, 222, 212, .25); }
        .form-control-custom::placeholder { color: #6b7280; }
        .form-control-custom[type="file"]::file-selector-button { padding: .5rem .75rem; margin: -.5rem -.75rem; margin-inline-end: .75rem; color: #022028; background-color: #5fded4; border-right: 1px solid #055058; border-top:0; border-left:0; border-bottom:0; border-radius: 0; transition: background-color .15s ease-in-out; }
        .form-control-custom[type="file"]::file-selector-button:hover { background-color: #4acbc1; }
        .submit-btn-custom { background-color: #5fded4; color: #022028; padding: 0.65rem 1.5rem; border-radius: 0.375rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; border: none; cursor: pointer; transition: background-color 0.2s, transform 0.1s; font-size: 0.9rem; }
        .submit-btn-custom:hover { background-color: #4acbc1; transform: translateY(-1px); }
        .error-messages-custom { background-color: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.5); color: #f87171; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1.5rem; font-size:0.9rem; }
        .error-messages-custom ul { list-style-position: inside; padding-left: 0.5rem; }
        .error-messages-custom li { margin-bottom: 0.25rem; }
        .text-red-400 { color: #f87171; }
        .text-gray-500 { color: #6b7280; }
        .text-xs { font-size: 0.75rem; }
        .mt-1 { margin-top: 0.25rem; }
        .db { display:block; }
        .mb-6 { margin-bottom: 1.5rem; }
        .text-teal-300 { color: #5eead4; }
        .text-teal-400 { color: #2dd4bf; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .font-semibold { font-weight: 600; }
        .mr-1 { margin-right: 0.25rem; }
        .mr-2 { margin-right: 0.5rem; }
        .auth-btn { padding: 0.5rem 1rem; background-color: #5fded4; color: #022028; border: none; border-radius: 0.375rem; font-weight: bold; font-family: "Montserrat", sans-serif; cursor: pointer; font-size: 0.875rem; text-decoration: none; display: inline-flex; align-items: center; }
        .auth-btn:hover { background-color: #4acbc1; }
        .auth-btn i.fas { margin-right: 0.5rem;}
        .hover\:underline:hover { text-decoration: underline; }

        /* === CHAT STYLES (Unified for Mensagens & IA) === */
        .chat-messages-display-area {
            background-color: #011a21;
            border: 1px solid #044048;
            padding: 1rem;
            border-radius: 6px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* Novas mensagens no final, scroll de baixo */
        }
        /* Wrapper interno para manter a ordem correta com column-reverse */
        .chat-messages-display-area > div {
            display: flex;
            flex-direction: column;
        }

        .chat-message-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
            max-width: 85%; /* Limita a largura da mensagem inteira */
        }
        .chat-message-container.user {
            align-items: flex-end;
            margin-left: auto; /* Alinha o container √† direita */
        }
        .chat-message-container.other {
            align-items: flex-start;
            margin-right: auto; /* Alinha o container √† esquerda */
        }

        .message-sender-name {
            font-size: 0.75rem; /* 12px */
            color: #9ca3af; /* cinza-400 */
            margin-bottom: 2px;
            font-weight: 500;
            padding: 0 8px; /* Pequeno padding lateral */
        }
        .chat-message-container.user .message-sender-name {
            text-align: right;
            color: #5eead4; /* text-teal-300, para destacar o pr√≥prio nome */
        }
        .chat-message-container.other .message-sender-name {
            text-align: left;
        }

        .message-bubble-wrapper {
            padding: 8px 15px; /* Ajustado o padding superior e inferior */
            border-radius: 18px;
            /* max-width: 75%; /* Movido para .chat-message-container para melhor controle do alinhamento */
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 0.9rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15); /* Sombra sutil */
        }
        .chat-message-container.user .message-bubble-wrapper {
            background-color: #5fded4;
            color: #022028;
            border-bottom-right-radius: 6px;
        }
        .chat-message-container.other .message-bubble-wrapper {
            background-color: #044048;
            color: #e5e7eb;
            border-bottom-left-radius: 6px;
        }
        .message-bubble-wrapper p.message-content { /* Alvo espec√≠fico para o conte√∫do */
            margin: 0 !important;
            font-family: 'Montserrat', sans-serif;
        }

        .message-timestamp-chat {
            font-size: 0.7rem; /* 11px */
            color: #6b7280; /* cinza-500 */
            margin-top: 4px;
            display: block;
        }
        .chat-message-container.user .message-timestamp-chat {
            text-align: right;
            color: #011A21;
        }
        .chat-message-container.other .message-timestamp-chat {
            text-align: left;
            color: #9ca3af; /* Cor mais clara para timestamp em bolhas 'other' */
        }
        
        /* Estilos para o input de chat - aplicados a AMBOS os chats */
        .chat-input-area {
            margin-top: 1rem;
        }
        .chat-form-group {
            display: flex;
            align-items: stretch; /* Faz textarea e bot√£o terem a mesma altura */
            gap: 0.5rem;
            height: 40px; 
        }
        .chat-form-group textarea {
            flex-basis: 80%;
            width: 80%; 
            height: 100%; 
            min-height: 40px;
            padding: 8px 12px; 
            line-height: 1.3; 
            font-size: 0.9rem; 
            box-sizing: border-box;
            background-color: #044048;
            color: #e5e7eb;
            border: 1px solid #055058;
            border-radius: 6px;
            resize: none; 
            font-family: 'Montserrat', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .chat-form-group textarea::placeholder {
            color: #6b7280;
        }
        .chat-form-group textarea:focus {
            border-color: #5fded4;
            box-shadow: 0 0 0 0.2rem rgba(95, 222, 212, 0.25);
            outline: none;
        }
        .chat-form-group button {
            flex-basis: 20%;
            width: 20%;
            height: 100%; 
            min-height: 40px;
            padding: 0 0.5rem; 
            font-size: 0.85rem; 
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            margin-top: 0 !important; 
            border-radius: 6px;
            background-color: #5fded4;
            color: #022028;
            border: none;
            font-weight: bold;
            font-family: "Montserrat", sans-serif;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            white-space: nowrap; /* Evita quebra de texto no bot√£o */
        }
        .chat-form-group button:hover {
            background-color: #4acbc1;
            transform: translateY(-1px);
        }
        .chat-form-group button .fas {
            margin-right: 0.3rem;
        }
        .chat-form-group button:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }
        
        .sim-section-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
            text-align: center;
        }
        .sim-content-box {
            background: #033038;
            padding: 30px;
            border-radius: 8px;
            margin: 0 auto 20px auto;
            box-sizing: border-box;
            text-align: left;
        }
        .sim-logo {
            display: block;
            max-width: 120px;
            margin: 0 auto 25px auto;
        }
        .sim-content-box h1 {
            font-size: 2rem;
            font-family: "Cal Sans", sans-serif;
            color: #fff;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        .sim-content-box > p.intro-text {
            text-align: center;
            font-size: 1.1rem;
            color: #9ca3af;
            font-family: "Montserrat", sans-serif;
            margin-bottom: 2rem;
        }
        .benefit-card h2, .summary-card h2 {
            font-size: 1.5rem;
            color: #5fded4;
            font-family: "Cal Sans", sans-serif;
            margin-bottom: 15px;
            border-bottom: 1px solid #055058;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .benefit-card h2 .fas, .summary-card h2 .fas {
            margin-right: 10px;
            font-size: 1.2em;
        }
        .benefit-card p, .summary-card p:not(.total-value-amount):not(.total-value-text) {
            color: #d1d5db;
            font-family: "Montserrat", sans-serif;
            margin-bottom: 15px;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .summary-card .total-value-text {
            font-size: 1.1rem;
            color: #d1d5db;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .summary-card .total-value-amount {
            font-size: 2.5rem;
            color: #5fded4;
            font-weight: bold;
            display: block;
            margin-bottom: 1.5rem;
            font-family: "Cal Sans", sans-serif;
            text-align: center;
        }
        .benefit-card, .summary-card {
            background: #044048;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.6s ease-in-out;
        }
        .simulation-action-btn {
            background-color: #5fded4;
            color: #022028;
            padding: 12px 25px;
            border-radius: 4px;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s ease;
            font-family: "Montserrat", sans-serif;
            font-size: 1rem;
            text-align: center;
        }
        .simulation-action-btn:hover {
            background-color: #4acbc1;
        }
        .simulation-action-btn.secondary {
            background-color: transparent;
            border: 2px solid #5fded4;
            color: #5fded4;
        }
        .simulation-action-btn.secondary:hover {
            background-color: rgba(95, 222, 212, 0.1);
        }
        .dynamic-icons-display span {
            font-size: 1.5rem;
            margin-right: 5px;
            display: inline-block;
        }
        canvas {
            max-width: 100%;
            width: 100% !important;
            display: block;
            margin: 20px auto 0 auto;
            max-height: 300px;
            min-height: 200px;
        }
        .metrics-grid {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .metric-card {
            background: #055058;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 130px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .metric-icon {
            font-size: 1.75rem;
            margin-bottom: 5px;
            line-height: 1;
        }
        .metric-label {
            font-size: 0.8rem;
            color: #9ca3af;
            text-transform: uppercase;
            min-height: 2.4em;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 3px;
        }
        .metric-value {
            font-size: 1.05rem;
            color: #5fded4;
            font-weight: bold;
        }
        .metric-value.highlight { color: #5fded4; }
        .custom-table {
            width: 100%;
            margin: 1.5rem 0;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .custom-table th, .custom-table td {
            border: 1px solid #055058;
            padding: 6px 8px;
            text-align: left;
            color: #d1d5db;
        }
        .custom-table th {
            background-color: #055058;
            color: #5fded4;
            font-weight: 600;
        }
        .error-messages-container {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #f87171;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1.5rem;
        }
        .error-messages-container .error-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #ef4444;
        }
        /* Fallback para legendas do Chart.js */
        .chart-legend {
            color: #ffffff !important;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 640px) {
            .sim-content-box { padding: 20px; }
            .sim-content-box h1 { font-size: 1.75rem; }
            .benefit-card h2, .summary-card h2 { font-size: 1.25rem; }
            canvas { max-height: 250px; }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .dashboard-header { height: auto; flex-direction: column; align-items: flex-start; padding: 10px; }
            .logo-container h1 { font-size: 1rem; }
            .header-right { width: 100%; margin-top: 10px; flex-direction: column; align-items: flex-start; }
            .search-container { width: 100%; margin-right: 0; margin-bottom:10px; }
            .header-icons { gap: 10px; }
            .dashboard-container { flex-direction: column; padding-top: 130px; }
            .sidebar { position: static; width: 100%; height: auto; border-right: none; border-bottom: solid 1px #000; padding: 10px 0; }
            .sidebar ul { display: flex; flex-wrap: wrap; justify-content: space-around;}
            .sidebar-item { width: 48%; margin-bottom: 5px;}
            .sidebar-item a { padding: 10px; font-size: 0.9rem; }
            .nav-icon-container svg { width: 16px; height: 16px; }
            .main-content-wrapper { margin-left: 0; width: 100%; padding: 15px; }
            .section { padding: 0; }
            .section-header h2 { font-size: 1.5rem; }
            .progress-card { width: 100%; flex-direction: column; align-items: flex-start;}
            .progress-icon { margin-bottom: 12px; }
            .chat-form-group { flex-direction: column; height: auto; }
            .chat-form-group textarea { flex-basis: auto; width:100%; margin-bottom: 0.5rem;}
            .chat-form-group button { flex-basis: auto; width:100%; min-height: 40px;}

        }
        #gpt-chat-container .text-muted { /* "Powered by OpenAI" text, etc. */
             color: #6b7280 !important;
        }
    </style>
{% endblock head_extra_styles %}

{% block content %}
<div class="dashboard-container">
    <nav class="sidebar">
        <ul>
            <li class="sidebar-item"><a href="#progresso"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>Progresso</div><span>&gt;</span></a></li>
            <li class="sidebar-item"><a href="#documentos"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M2 15h10"></path><path d="M9 18l3-3-3-3"></path></svg>Documentos</div><span>&gt;</span></a></li>
            <li class="sidebar-item"><a href="#socios"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>S√≥cios</div><span>&gt;</span></a></li>
            <li class="sidebar-item"><a href="#mensagens"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>Mensagens</div><span>&gt;</span></a></li>
            <li class="sidebar-item"><a href="#simulacao"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"></rect><rect x="8" y="6" width="8" height="2"></rect><line x1="8" y1="11" x2="16" y2="11"></line><line x1="8" y1="14" x2="16" y2="14"></line><line x1="8" y1="17" x2="16" y2="17"></line></svg>Simula√ß√£o</div><span>&gt;</span></a></li>
            <li class="sidebar-item">
    <a href="#ia">
        <div class="nav-icon-container">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="5" y="8" width="14" height="10" rx="2"></rect>
                <path d="M7 4h10v4H7z"></path>
                <line x1="9.5" y1="12.5" x2="9.5" y2="13.5"></line> 
                <line x1="14.5" y1="12.5" x2="14.5" y2="13.5"></line> 
            </svg>
            Assistente
        </div>
        <span>&gt;</span>
    </a>
</li>
            <li class="sidebar-item" style="margin-top: 20px; ">
                <a href="{% url 'account_logout' %}" id="logout" class="logout-btn"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>Sair</div><span>&gt;</span></a></li>
        </ul>
    </nav>

    <div class="main-content-wrapper">
        <main class="main-content">
            {% if messages %}
                <div class="django-messages-container">
                {% for message in messages %}
                    <div class="p-3 mb-3 rounded-md text-sm
                                {% if message.tags == 'success' %} bg-green-100 border border-green-400 text-green-700
                                {% elif message.tags == 'error' %} bg-red-100 border border-red-400 text-red-700
                                {% elif message.tags == 'warning' %} bg-yellow-100 border border-yellow-400 text-yellow-700
                                {% else %} bg-blue-100 border border-blue-400 text-blue-700 {% endif %}"
                                role="alert" style="color: #1f2937; background-color: {% if message.tags == 'success' %}#d1fae5{% elif message.tags == 'error' %}#fee2e2{% elif message.tags == 'warning' %}#fef3c7{% else %}#dbeafe{% endif %}; border-color: {% if message.tags == 'success' %}#6ee7b7{% elif message.tags == 'error' %}#fca5a5{% elif message.tags == 'warning' %}#fcd34d{% else %}#93c5fd{% endif %};">
                        {{ message }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}

            <section id="progresso" class="section active">
                <div class="section-header">
                    <h2><svg class="title-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>Seu Progresso</h2>
                </div>
                <div class="progress-list">
                    <div class="progress-card">
                        <div class="progress-icon"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
                        <div class="progress-content">
                            <h3 class="progress-title">Cadastro</h3>
                            <p class="progress-description">Crie sua conta com informa√ß√µes b√°sicas para come√ßar o processo.</p>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: 100%;"></div></div>
                            <p class="status-text mt-2">100% Conclu√≠do <i class="fas fa-check-circle text-green-400"></i></p>
                        </div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"></rect><line x1="6" y1="9" x2="18" y2="9"></line><line x1="6" y1="14" x2="18" y2="14"></line></svg></div>
                        <div class="progress-content">
                            <h3 class="progress-title">Formul√°rio de Simula√ß√£o</h3>
                            <p class="progress-description">Preencha os detalhes para ver os benef√≠cios de uma holding.</p>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: {{ latest_simulation|yesno:'100,0' }}%;"></div></div>
                            <p class="status-text mt-2">
                                {% if latest_simulation %}100% Conclu√≠do <i class="fas fa-check-circle text-green-400"></i>{% else %}Pendente <i class="fas fa-hourglass-half text-yellow-400"></i>{% endif %}
                                <br><a href="{% url 'simulation' %}" class="text-teal-400 hover:underline text-sm">Fazer/Refazer Simula√ß√£o</a>
                            </p>
                        </div>
                    </div>
                    <div class="progress-card {% if not user_holdings %}incomplete{% endif %}">
                        <div class="progress-icon"><svg viewBox="0 0 24 24" stroke="{% if user_holdings %}#5fded4{% else %}#fff{% endif %}"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div>
                        <div class="progress-content">
                            <h3 class="progress-title {% if not user_holdings %}text-white{% endif %}">Cria√ß√£o da Holding</h3>
                            <p class="progress-description">Preenchimento dos dados para o registro da sua holding.</p>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: {% if user_holdings %}100{% else %}0{% endif %};"></div></div>
                            <p class="status-text mt-2">
                                {% if user_holdings %}Conclu√≠do <i class="fas fa-check-circle text-green-400"></i>{% else %}Pendente <i class="fas fa-hourglass-half text-yellow-400"></i>{% endif %}
                                {% if not user_holdings and latest_simulation %}<br><a href="{% url 'create_holding' %}" class="text-teal-400 hover:underline text-sm">Iniciar Cria√ß√£o da Holding</a>{% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="progress-card incomplete">
                        <div class="progress-icon"><svg viewBox="0 0 24 24" stroke="#fff"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div>
                        <div class="progress-content">
                            <h3 class="progress-title">Documenta√ß√£o</h3>
                            <p class="progress-description">Envio dos documentos necess√°rios para formaliza√ß√£o.</p>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: {% if folder_structure or root_documents %}25{% else %}0{% endif %};"></div></div> {# Basic check if any docs/folders exist #}
                            <p class="status-text mt-2">
                                {% if folder_structure or root_documents %}Em Andamento <i class="fas fa-tasks text-blue-400"></i>
                                {% else %}Pendente <i class="fas fa-hourglass-half text-yellow-400"></i>{% endif %}
                                <br><a href="#documentos" class="text-teal-400 hover:underline text-sm switch-section-link">Enviar/Ver Documentos</a>
                            </p>
                        </div>
                    </div>
                     <div class="progress-card incomplete">
                        <div class="progress-icon"><svg viewBox="0 0 24 24" stroke="#fff"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
                        <div class="progress-content">
                            <h3 class="progress-title">Intera√ß√£o com Consultor</h3>
                            <p class="progress-description">Converse com um especialista para alinhar os pr√≥ximos passos.</p>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: {% if chat_messages %}25{% else %}0{% endif %};"></div></div> {# Basic check if any chat messages exist #}
                            <p class="status-text mt-2">
                                {% if chat_messages %}Em Andamento <i class="fas fa-tasks text-blue-400"></i>
                                {% else %}Pendente <i class="fas fa-hourglass-half text-yellow-400"></i>{% endif %}
                                <br><a href="#mensagens" class="text-teal-400 hover:underline text-sm switch-section-link">Acessar Chat</a>
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="documentos" class="section">
                <div class="section-header">
                    <h2>
                        <svg class="title-icon" viewBox="0 0 24 24"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M2 15h10"></path><path d="M9 18l3-3-3-3"></path></svg>
                        Documentos da Holding: {% if active_holding_for_docs %}{{ active_holding_for_docs.nome_holding }}{% else %}N/A{% endif %}
                    </h2>
                </div>
            
                {% if active_holding_for_docs and target_processo_id %}
                    <div class="content-card mb-6">
                        <h4 class="text-xl cal-sans-regular text-teal-300 mb-1">Enviar Novo Documento</h4>
                        <p class="text-sm text-gray-400 mb-4">Para a holding: <strong>{{ active_holding_for_docs.nome_holding }}</strong> (Processo ID: {{ target_processo_id }})</p>
                        
                        {% if document_form.non_field_errors %}
                            <div class="error-messages-custom !mb-3">
                                {% for error in document_form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}

                        <form method="post" enctype="multipart/form-data" action="{% url 'dashboard_final' %}#documentos">
                            {% csrf_token %}
                            {% for field in document_form %}
                                <div class="form-group-custom">
                                    <label for="{{ field.id_for_label }}" class="text-gray-300">{{ field.label }}</label>
                                    {{ field }} 
                                    {% if field.help_text %}<small class="text-gray-500 text-xs mt-1 db">{{ field.help_text|safe }}</small>{% endif %}
                                    {% if field.errors %}<div class="text-red-400 text-sm mt-1">{{ field.errors|join:", " }}</div>{% endif %}
                                </div>
                            {% endfor %}
                            <button type="submit" name="upload_document_cliente" class="submit-btn-custom mt-3">
                                <i class="fas fa-upload mr-2"></i>Enviar Documento
                            </button>
                        </form>
                    </div>

                    <div class="content-card mb-6">
                        <h4 class="text-xl cal-sans-regular text-teal-300 mb-1">Criar Nova Pasta</h4>
                         {% if pasta_form.non_field_errors %}
                            <div class="error-messages-custom !mb-3">
                                {% for error in pasta_form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                        <form method="post" action="{% url 'dashboard_final' %}#documentos">
                            {% csrf_token %}
                            {% for field in pasta_form %}
                                <div class="form-group-custom">
                                    <label for="{{ field.id_for_label }}" class="text-gray-300">{{ field.label }}</label>
                                    {{ field }}
                                    {% if field.help_text %}<small class="text-gray-500 text-xs mt-1 db">{{ field.help_text|safe }}</small>{% endif %}
                                    {% if field.errors %}<div class="text-red-400 text-sm mt-1">{{ field.errors|join:", " }}</div>{% endif %}
                                </div>
                            {% endfor %}
                            <button type="submit" name="create_folder" class="submit-btn-custom mt-3">
                                <i class="fas fa-folder-plus mr-2"></i>Criar Pasta
                            </button>
                        </form>
                    </div>
        
                    <h4 class="text-xl cal-sans-regular text-teal-300 mb-3 mt-6">Seus Documentos e Pastas</h4>
                    {% if folder_structure or root_documents %}
                        {% with folders=folder_structure documents=root_documents user_is_management=False target_processo_id=target_processo_id pasta_creation_form=pasta_form %}
                            {% include "core/folder_tree_display.html" %}
                        {% endwith %}
                    {% else %}
                        <div class="content-card p-4"><p class="text-gray-400 italic">Nenhum documento ou pasta para este processo ainda.</p></div>
                    {% endif %}
                {% else %}
                     <div class="content-card p-4"><p class="text-gray-400">Nenhum processo de holding ativo encontrado ou selecionado. Por favor, inicie a cria√ß√£o de uma holding para gerenciar documentos.</p></div>
                {% endif %}
            </section>

            <section id="socios" class="section">
                <div class="section-header">
                    <h2><svg class="title-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>S√≥cios da Holding</h2>
                    {% if user_holdings.first %}
                        <a href="{% url 'invite_partners' %}" class="auth-btn"><i class="fas fa-user-plus"></i> Convidar S√≥cio</a>
                    {% endif %}
                </div>
                {% if user_holdings %}
                    {% for holding in user_holdings %}
                        <div class="content-card mb-6">
                            <h4 class="text-xl cal-sans-regular text-teal-300 mb-3">Holding: {{ holding.nome_holding }}</h4>
                            {% if holding.clientes.all|length > 1 %}
                            <table class="table">
                                <thead><tr><th>Nome do S√≥cio</th><th>E-mail</th></tr></thead>
                                <tbody>
                                {% for socio in holding.clientes.all %}
                                    {% if socio != request.user %}
                                    <tr>
                                        <td>{{ socio.get_full_name|default:"Nome n√£o informado" }}</td>
                                        <td>{{ socio.email }}</td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p class="text-gray-400 italic">Ainda n√£o h√° outros s√≥cios convidados para "{{holding.nome_holding}}".</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="content-card p-4"><p class="text-gray-400">Nenhuma holding criada para listar s√≥cios.</p></div>
                {% endif %}
            </section>

            <section id="mensagens" class="section">
                <div class="section-header">
                    <h2>
                        <svg class="title-icon" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                        Mensagens da Holding
                    </h2>
                </div>
                        
                <div id="chat-message-area" class="chat-messages-display-area mb-3" style="height: 330px;">
                    {% if chat_messages %}
                        <div> {# Wrapper para manter a ordem correta com column-reverse #}
                        {% for message in chat_messages %}
                            <div class="chat-message-container {% if message.sender == request.user %}user{% else %}other{% endif %}">
                                <div class="message-sender-name">
                                    {% if message.sender == request.user %}
                                        
                                    {% else %}
                                        {{ message.sender.first_name|default:message.sender.email.split|capfirst }}
                                    {% endif %}
                                    {% if message.sender.is_superuser %}
                                        <span class="text-xs" style="color: #f87171;">(Admin)</span>
                                    {% elif message.sender.user_type == 'consultor' %}
                                        <span class="text-xs" style="color: #facc15;">(Consultor)</span>
                                    {% endif %}
                                </div>
                                <div class="message-bubble-wrapper">
                                    <p class="message-content">{{ message.content|linebreaksbr }}</p>
                                    <span class="message-timestamp-chat">{{ message.timestamp|date:"d/m, H:i" }}</span>
                                </div>
                            </div>
                        {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-gray-500 italic text-center m-auto">Nenhuma mensagem neste chat ainda. Seja o primeiro a enviar!</p>
                    {% endif %}
                </div>

                {% if request.user.is_superuser or request.user in active_holding_for_chat.clientes.all or request.user in active_holding_for_chat.consultores.all %}
                    <form method="post" action="{% url 'dashboard_final' %}#mensagens" class="chat-input-area">
                        {% csrf_token %}
                        <div class="chat-form-group">
                            {{ chat_form.content }} 
                            <button type="submit" name="send_chat_message">
                                <i class="fas fa-paper-plane mr-1"></i> Enviar
                            </button>
                        </div>
                        {% if chat_form.content.errors %}
                            <div class="text-red-400 text-xs mt-1">{{ chat_form.content.errors|join:", " }}</div>
                        {% endif %}
                         {% if chat_form.non_field_errors %}
                            <div class="text-red-400 text-xs mt-1">{{ chat_form.non_field_errors|join:", " }}</div>
                        {% endif %}
                    </form>
                {% else %}
                    <p class="text-sm text-gray-500 italic mt-3">Voc√™ n√£o tem permiss√£o para enviar mensagens neste chat.</p>
                {% endif %}
            </section>

            <section id="notificacoes" class="section">
                <div class="section-header"><h2><i class="fas fa-bell mr-2"></i>Notifica√ß√µes</h2></div>
                 <div class="content-card p-4">
                    <p class="text-gray-400 italic">Nenhuma notifica√ß√£o nova no momento.</p>
                </div>
            </section>

            <section id="simulacao" class="section">
    <div class="section-header">
        <h2><svg class="title-icon" viewBox="0 0 24 24">...</svg>Sua Simula√ß√£o Detalhada</h2>
    </div>

    {% if simulation_instance %} 

            {% if not total_savings and not inventory_savings and not profit_savings and not rental_savings and not investment_savings %}
                <div class="error-messages-container">
                    <p class="error-title">Erro na Simula√ß√£o</p>
                    <p>N√£o foi poss√≠vel calcular os benef√≠cios com os dados fornecidos. Por favor, refa√ßa a simula√ß√£o ou entre em contato com o suporte.</p>
                </div>
            {% endif %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% if number_of_properties > 0 or number_of_heirs > 0 %}
                    <div class="benefit-card">
                        <h2><i class="fas fa-home"></i> Seus Im√≥veis e Sucess√£o ({{ property_state|default:"Estado n√£o informado" }})</h2>
                        <div id="property-icons-dash" class="dynamic-icons-display"></div> <p>{{ property_succession_text|safe }}</p>
                        {% if number_of_heirs > 0 and number_of_properties > 0 %}
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <span class="metric-icon">üßæ</span>
                                    <div class="metric-label">Custo Invent√°rio (S/ Holding)</div>
                                    <div class="metric-value highlight">R$ {% localize off %}{{ inventory_cost_without|floatformat:2|intcomma }}{% endlocalize %}</div>
                                </div>
                                <div class="metric-card">
                                    <span class="metric-icon">‚è≥</span>
                                    <div class="metric-label">Tempo M√©dio Invent√°rio</div>
                                    <div class="metric-value">{% localize off %}{{ inventory_time_without }}{% endlocalize %} meses</div>
                                </div>
                                <div class="metric-card">
                                    <span class="metric-icon">‚öñÔ∏è</span>
                                    <div class="metric-label">Risco de Conflito</div>
                                    <div class="metric-value">{{ conflict_risk }}</div>
                                </div>
                                <div class="metric-card">
                                    <span class="metric-icon">‚úÖ</span>
                                    <div class="metric-label">Com Holding</div>
                                    <div class="metric-value">Planejado em Vida</div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}

                {% if has_companies == 'yes' and number_of_companies > 0 %}
                    <div class="benefit-card">
                        <h2><i class="fas fa-briefcase"></i> Suas Empresas</h2>
                        <div id="company-icons-dash" class="dynamic-icons-display"></div> <p>{{ profit_text|safe }}</p>
                        {% if company_tax_regime != 'simples' and monthly_profit > 0 %}
                            <table class="custom-table">
                                <thead>
                                    <tr><th>Regime</th><th>Lucro Anual</th><th>IRPF (S/ Holding)</th><th>IRPF (C/ Holding)</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>{{ company_tax_regime_display }}</td>
                                        <td>R$ {% localize off %}{{ annual_profit|floatformat:2|intcomma }}{% endlocalize %}</td>
                                        <td>~{% localize off %}{{ PROFIT_TAX_PF_RATE|floatformat:1 }}{% endlocalize %}%</td>
                                        <td>Isento</td>
                                    </tr>
                                </tbody>
                            </table>
                            {% if profit_savings > 0 %}
                                <canvas id="profitChartDash"></canvas> {% endif %}
                        {% elif company_tax_regime == 'simples' %}
                            <p>Empresas no Simples Nacional j√° possuem isen√ß√£o na distribui√ß√£o de lucros...</p>
                        {% endif %}
                    </div>
                {% endif %}

                {% if receives_rent == 'yes' and monthly_rent > 0 %}
                    <div class="benefit-card">
                        <h2><i class="fas fa-key"></i> Seus Alugu√©is (Im√≥veis)</h2>
                        <p>Seus alugu√©is de R$ {% localize off %}{{ monthly_rent|floatformat:2|intcomma }}{% endlocalize %} ... {{ rental_text|safe }}</p>
                        {% if rental_savings > 0 %}
                            <canvas id="rentalChartDash"></canvas> {% endif %}
                    </div>
                {% endif %}

                {% if has_investments == 'yes' and total_investment_value > 0 %}
                     <div class="benefit-card">
                         <h2><i class="fas fa-chart-line"></i> Seus Investimentos</h2>
                         <p>Seus investimentos de R$ {% localize off %}{{ total_investment_value|floatformat:2|intcomma }}{% endlocalize %} ... {{ investment_text|safe }}</p>
                         {% if investment_savings > 0 %}
                             <canvas id="investmentChartDash"></canvas> {% endif %}
                     </div>
                 {% endif %}
            </div>

            {% if total_savings <= 0 and inventory_savings <= 0 and profit_savings <= 0 and rental_savings <= 0 and investment_savings <= 0 %}
                <div class="benefit-card">
                    </div>
            {% else %}
                <div class="summary-card mt-8">
                    <h2><i class="fas fa-piggy-bank"></i> Resumo dos Benef√≠cios</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-center">
                        <div class="flex flex-col justify-center gap-4">
                            </div>
                        <div>
                            {% if total_savings > 0 %}
                            <div style="max-height: 280px; min-height: 200px; margin: 1rem 0;"> <canvas id="totalSavingsChartDash"></canvas> </div>
                            {% endif %}
                            <p class="total-value-text mt-4">Economia Total Estimada (1¬∫ ano):</p>
                            <p class="total-value-amount">R$ {% localize off %}{{ total_savings|floatformat:2|intcomma }}{% endlocalize %}</p>
                        </div>
                        <div class="flex flex-col justify-center gap-4">
                            </div>
                    </div>
                    
                </div>
            {% endif %}
        
    {% endif %}
</section>

            <section id="ia" class="section">
                <div class="section-header">
                    <h2><svg class="title-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"></circle><path d="M16 8v5a3 3 0 0 0 6 0v-1a3 3 0 1 0-3-3"></path><path d="M8 16v-5a3 3 0 0 0-6 0v1a3 3 0 1 0 3 3"></path></svg>Intelig√™ncia Artificial</h2>
                </div>
                    <div id="gpt-chat-container">
                    <div id="gpt-chat-messages" class="chat-messages-display-area mb-2" style="flex-grow: 1; height: 330px;">
                        <div> {# Wrapper interno para mensagens manterem a ordem correta com column-reverse #}
                            <div class="chat-message-container other">
                                <div class="message-sender-name">Assistente IA W1</div>
                                <div class="message-bubble-wrapper">
                                    <p class="message-content">Ol√°, {{ request.user.first_name|default:request.user.email.split|capfirst }}! Sou o assistente virtual da W1 Holding. Como posso te ajudar hoje?</p>
                                    {# <span class="message-timestamp-chat">Agora</span> #}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="gpt-chat-input-container" class="chat-input-area">
                        <form id="gpt-chat-form" class="chat-form-group">
                            <textarea id="gpt-user-message" name="content" placeholder="Digite sua pergunta..." autocomplete="off" aria-label="Sua mensagem para o Assistente IA" rows="1"></textarea>
                            <button type="submit" id="gpt-send-button">
                                <i class="fas fa-paper-plane"></i> Enviar
                            </button>
                        </form>
                    </div>
                </div>
            </section>
            </main>
    </div>
</div>
{% endblock %}

{% block footer %}{% endblock %}

{% block scripts %}
    {{ block.super }}

    {# Script para Chart.js s√≥ √© inclu√≠do se houver uma simula√ß√£o #}
    {% if simulation_instance %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    {% endif %}

    <script>
    // Fun√ß√£o para inicializar os gr√°ficos da simula√ß√£o.
    // Ser√° definida completamente apenas se simulation_instance existir,
    // mas a fun√ß√£o em si precisa existir para ser chamada sem erro.
    function initializeSimulationCharts() {
        {% if simulation_instance %}
            // S√≥ executa a l√≥gica dos gr√°ficos se a se√ß√£o estiver ativa e os dados existirem
            const simulationSection = document.getElementById('simulacao');
            if (!simulationSection || !simulationSection.classList.contains('active')) {
                // console.log("DEBUG: initializeSimulationCharts - Se√ß√£o simula√ß√£o n√£o ativa.");
                return;
            }
            console.log("DEBUG Dashboard: Executando initializeSimulationCharts()...");

            // Destruir gr√°ficos anteriores
            ['profitChartDash', 'rentalChartDash', 'investmentChartDash', 'totalSavingsChartDash'].forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas && Chart.getChart(canvas)) {
                    Chart.getChart(canvas).destroy();
                }
            });

            // Defaults do Chart.js
            Chart.defaults.color = '#d1d5db';
            Chart.defaults.font.family = "'Montserrat', sans-serif";
            // ... (copie o resto das suas Chart.defaults aqui) ...
            Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(5, 80, 88, 0.95)';
            Chart.defaults.plugins.tooltip.titleFont = { size: 14, weight: 'bold', family: "'Cal Sans', sans-serif" };
            Chart.defaults.plugins.tooltip.bodyFont = { size: 12 };
            Chart.defaults.plugins.tooltip.padding = 10;
            Chart.defaults.plugins.tooltip.cornerRadius = 4;
            Chart.defaults.plugins.tooltip.usePointStyle = true;


            const tooltipLabelCallback = function(context) { /* ... (sua fun√ß√£o) ... */
                let label = context.dataset.label || ''; if (label) { label += ': '; }
                let value = context.parsed.y || 0;
                label += `R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                return label;
            };
            const pieTooltipLabelCallback = function(context) { /* ... (sua fun√ß√£o) ... */
                const value = context.raw;
                return `${context.label}: R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };
            function createGradient(ctx, chartArea, colorStart, colorEnd) { /* ... (sua fun√ß√£o) ... */
                 if (!chartArea) return null;
                const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                gradient.addColorStop(0, colorEnd); gradient.addColorStop(1, colorStart); return gradient;
            }

            // √çcones din√¢micos
            const propertyIconsDivDash = document.getElementById('property-icons-dash');
            if (propertyIconsDivDash && parseFloat("{{ number_of_properties|default:0 }}") > 0) {
                propertyIconsDivDash.innerHTML = '';
                for (let i = 0; i < Math.min(parseFloat("{{ number_of_properties|default:0 }}"), 7); i++) {
                    const icon = document.createElement('span'); icon.textContent = 'üè†'; propertyIconsDivDash.appendChild(icon);
                }
            }
            const companyIconsDivDash = document.getElementById('company-icons-dash');
            if (companyIconsDivDash && parseFloat("{{ number_of_companies|default:0 }}") > 0) {
                companyIconsDivDash.innerHTML = '';
                for (let i = 0; i < Math.min(parseFloat("{{ number_of_companies|default:0 }}"), 7); i++) {
                    const icon = document.createElement('span'); icon.textContent = 'üè¢'; companyIconsDivDash.appendChild(icon);
                }
            }

            // Gr√°fico de Lucros
            const profitChartCanvasDash = document.getElementById('profitChartDash');
            if (profitChartCanvasDash && parseFloat("{{ profit_savings|default:0|unlocalize }}") > 0 && '{{ has_companies }}' === 'yes' && '{{ company_tax_regime }}' !== 'simples') {
                const profitCtxDash = profitChartCanvasDash.getContext('2d');
                const profitSavingsVal = parseFloat("{{ profit_savings|default:0|unlocalize }}");
                const years = ['Ano 1', 'Ano 2', 'Ano 3', 'Ano 4', 'Ano 5'];
                const accumulatedProfitSavings = years.map((_, i) => profitSavingsVal * (i + 1));
                new Chart(profitCtxDash, { /* ... (configura√ß√£o do seu gr√°fico de lucros) ... */
                    type: 'line', data: { labels: years,
                    datasets: [{ label: 'Economia Acumulada Lucros (R$)', data: accumulatedProfitSavings, borderColor: '#5fded4',
                        backgroundColor: function(context) { const chart = context.chart; const {ctx, chartArea} = chart; if (!chartArea) return null; return createGradient(ctx, chartArea, 'rgba(95, 222, 212, 0.3)', 'rgba(95, 222, 212, 0)'); },
                        fill: true, tension: 0.3, pointRadius: 5, pointBackgroundColor: '#5fded4', pointBorderColor: '#fff', pointBorderWidth: 2, pointHoverRadius: 8 }]
                }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#d1d5db' } }, y: { beginAtZero: true, ticks: { color: '#d1d5db', callback: value => `R$ ${value.toLocaleString('pt-BR')}` } } },
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#d1d5db', boxWidth: 20, padding: 15 } }, tooltip: { callbacks: { label: tooltipLabelCallback } } },
                    animation: { duration: 1000, easing: 'easeOutQuart' } }
                });
            } else { console.log("DEBUG Dashboard: Gr√°fico de Lucros N√ÉO renderizado (condi√ß√µes ou canvas n√£o atendidos)."); }

            // Gr√°fico de Alugu√©is (copie e cole sua l√≥gica, ajustando o ID do canvas)
            const rentalChartCanvasDash = document.getElementById('rentalChartDash');
            if (rentalChartCanvasDash && parseFloat("{{ rental_savings|default:0|unlocalize }}") > 0 && '{{ receives_rent }}' === 'yes' && parseFloat("{{ annual_rent|default:0|unlocalize }}") > 0) {
                // ... L√≥gica do gr√°fico de alugu√©is ...
                const rentalCtxDash = rentalChartCanvasDash.getContext('2d');
                const rentalSavingsVal = parseFloat("{{ rental_savings|default:0|unlocalize }}");
                const years = ['Ano 1', 'Ano 2', 'Ano 3', 'Ano 4', 'Ano 5'];
                const accumulatedRentalSavings = years.map((_, i) => rentalSavingsVal * (i + 1));
                new Chart(rentalCtxDash, { type: 'line', data: { labels: years,
                    datasets: [{ label: 'Economia Acumulada Alugu√©is (R$)', data: accumulatedRentalSavings, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.3)', fill: true, tension: 0.2, borderWidth: 1, pointRadius: 0 }]
                }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#d1d5db', maxRotation: 45, minRotation: 45 } }, y: { beginAtZero: true, ticks: { color: '#d1d5db', callback: value => `R$ ${value.toLocaleString('pt-BR')}` } } },
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#d1d5db', boxWidth: 20, padding: 15 } }, tooltip: { callbacks: { label: tooltipLabelCallback } } },
                    animation: { duration: 1200, easing: 'easeInOutQuad' } }
                });
            } else { console.log("DEBUG Dashboard: Gr√°fico de Alugu√©is N√ÉO renderizado."); }


            // Gr√°fico de Investimentos (copie e cole sua l√≥gica, ajustando o ID do canvas)
            const investmentChartCanvasDash = document.getElementById('investmentChartDash');
            if (investmentChartCanvasDash && parseFloat("{{ investment_savings|default:0|unlocalize }}") > 0 && '{{ has_investments }}' === 'yes' && parseFloat("{{ total_investment_value|default:0|unlocalize }}") > 0) {
                // ... L√≥gica do gr√°fico de investimentos ...
                const investmentCtxDash = investmentChartCanvasDash.getContext('2d');
                const investmentSavingsVal = parseFloat("{{ investment_savings|default:0|unlocalize }}");
                const years = ['Ano 1', 'Ano 2', 'Ano 3', 'Ano 4', 'Ano 5'];
                const accumulatedInvestmentSavings = years.map((_, i) => investmentSavingsVal * (i + 1));
                new Chart(investmentCtxDash, { type: 'bar', data: { labels: years,
                    datasets: [{ label: 'Economia Acumulada Investimentos (R$)', data: accumulatedInvestmentSavings, backgroundColor: '#f59e0b', hoverBackgroundColor: '#d97706', borderRadius: 8, borderSkipped: false }]
                }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#d1d5db' } }, y: { beginAtZero: true, ticks: { color: '#d1d5db', callback: value => `R$ ${value.toLocaleString('pt-BR')}` } } },
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#d1d5db', boxWidth: 20, padding: 15 } }, tooltip: { callbacks: { label: tooltipLabelCallback } } },
                    animation: { duration: 1500, easing: 'easeOutBounce', y: { from: 0 } } }
                });
            } else { console.log("DEBUG Dashboard: Gr√°fico de Investimentos N√ÉO renderizado."); }

            // Gr√°fico de Pizza (copie e cole sua l√≥gica, ajustando o ID do canvas)
            const totalSavingsChartCanvasDash = document.getElementById('totalSavingsChartDash');
            if (totalSavingsChartCanvasDash && parseFloat("{{ total_savings|default:0|unlocalize }}") > 0) {
                // ... L√≥gica do gr√°fico de pizza ...
                const totalSavingsCtxDash = totalSavingsChartCanvasDash.getContext('2d');
                const savingsData = []; const savingsLabels = [];
                const savingsColors = ['#1552b3', '#5fded4', '#10b981', '#f59e0b'];

                if (parseFloat("{{ inventory_savings|default:0|unlocalize }}") > 0) { savingsData.push(parseFloat("{{ inventory_savings|unlocalize }}")); savingsLabels.push('Invent√°rio'); }
                if (parseFloat("{{ profit_savings|default:0|unlocalize }}") > 0) { savingsData.push(parseFloat("{{ profit_savings|unlocalize }}")); savingsLabels.push('Lucros Empresa'); }
                if (parseFloat("{{ rental_savings|default:0|unlocalize }}") > 0) { savingsData.push(parseFloat("{{ rental_savings|unlocalize }}")); savingsLabels.push('Alugu√©is'); }
                if (parseFloat("{{ investment_savings|default:0|unlocalize }}") > 0) { savingsData.push(parseFloat("{{ investment_savings|unlocalize }}")); savingsLabels.push('Investimentos'); }

                if (savingsData.length > 0) {
                    new Chart(totalSavingsCtxDash, {
                        type: 'doughnut', data: { labels: savingsLabels, datasets: [{
                            label: 'Distribui√ß√£o da Economia', data: savingsData,
                            backgroundColor: savingsColors.slice(0, savingsData.length),
                            borderColor: '#032830', borderWidth: 2, hoverOffset: 8 }]
                        }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%',
                            plugins: { legend: { position: 'bottom', labels: { color: '#d1d5db', padding: 10, font: {size: 11} } },
                                tooltip: { callbacks: { label: pieTooltipLabelCallback } },
                                title: { display: true, text: 'Composi√ß√£o da Economia Total (1¬∫ Ano)', color: '#5fded4', padding: { top: 0, bottom: 15 }, font: { size: 16, family: "'Cal Sans', sans-serif" } }
                            }, animation: { duration: 1000, easing: 'easeInOutCirc' } }
                    });
                }
            } else { console.log("DEBUG Dashboard: Gr√°fico de Pizza N√ÉO renderizado."); }
        {% else %}
            // console.log("DEBUG: simulation_instance n√£o definida, initializeSimulationCharts n√£o far√° nada.");
        {% endif %}
    } // Fim da fun√ß√£o initializeSimulationCharts

    document.addEventListener('DOMContentLoaded', () => {
        const sidebarLinks = document.querySelectorAll('.sidebar-item a');
        const sections = document.querySelectorAll('.main-content .section');
        const notificationIcon = document.querySelector('.notification-icon');
        const switchSectionLinks = document.querySelectorAll('.switch-section-link');
        const chatMessageArea = document.getElementById('chat-message-area'); 
        const gptChatMessageArea = document.getElementById('gpt-chat-messages');

        function scrollToBottom(element) { if (element) { element.scrollTop = element.scrollHeight; } }
        scrollToBottom(chatMessageArea); scrollToBottom(gptChatMessageArea);

        function showSection(targetId) {
            const cleanTargetId = targetId.startsWith('#') ? targetId.substring(1) : targetId;
            
            sections.forEach(section => {
                const sectionIsNowActive = section.id === cleanTargetId;
                const sectionWasActive = section.classList.contains('active');

                if (sectionIsNowActive) {
                    if (!sectionWasActive) { // S√≥ adiciona e chama se n√£o estava ativa
                        section.classList.add('active');
                        if (cleanTargetId === 'simulacao' && typeof initializeSimulationCharts === 'function') {
                            console.log("DEBUG: Aba Simula√ß√£o ativada via showSection, chamando initializeSimulationCharts().");
                            setTimeout(initializeSimulationCharts, 50); // Pequeno delay para DOM render
                        }
                    }
                } else {
                    section.classList.remove('active');
                }
            });

            sidebarLinks.forEach(link => { /* ... (sua l√≥gica de ativar link da sidebar) ... */ 
                const linkHref = link.getAttribute('href');
                const linkDataSection = link.getAttribute('data-section');
                const parentLi = link.closest('.sidebar-item');
                if (parentLi) {
                    parentLi.classList.remove('active');
                    if ((linkHref && linkHref.substring(1) === cleanTargetId) || (linkDataSection && linkDataSection === cleanTargetId)) {
                        parentLi.classList.add('active');
                    }
                }
            });
            if (cleanTargetId === 'mensagens') scrollToBottom(chatMessageArea);
            if (cleanTargetId === 'ia') scrollToBottom(gptChatMessageArea);
        }

        sidebarLinks.forEach(link => {
            const href = link.getAttribute('href');
            if ((href && href.startsWith('#')) || link.hasAttribute('data-section')) {
                link.addEventListener('click', (e) => {
                    const targetIdFromHref = href && href.startsWith('#') ? href.substring(1) : null;
                    const targetIdFromData = link.getAttribute('data-section');
                    const targetId = targetIdFromData || targetIdFromHref;
                    if (targetId && targetId !== 'logout') { 
                        e.preventDefault(); showSection(targetId);
                        if (targetIdFromHref) { history.pushState(null, null, '#' + targetId); }
                    } else if (href && href.includes('logout')) { return; }
                });
            }
        });
        
        switchSectionLinks.forEach(link => { /* ... (seu listener de clique) ... */ });
        if (notificationIcon) { /* ... (seu listener de clique) ... */ }

        let initialSectionId = 'progresso'; 
        if (window.location.hash) {
            const hashId = window.location.hash.substring(1);
            if (document.getElementById(hashId)) { initialSectionId = hashId; }
        }
        
        if (document.getElementById(initialSectionId)) {
            showSection(initialSectionId);
        } else if (sections.length > 0) { 
            sections[0].classList.add('active'); // Ativa a primeira se√ß√£o se a inicial n√£o for encontrada
            const firstSectionId = sections[0].id;
            if (firstSectionId === 'simulacao' && typeof initializeSimulationCharts === 'function') {
                 console.log("DEBUG: Aba Simula√ß√£o √© a inicial, chamando initializeSimulationCharts() no carregamento.");
                 setTimeout(initializeSimulationCharts, 50);
            }
        }
    });

    // Script do Chat GPT (coloque o seu script do chat GPT aqui, dentro de um DOMContentLoaded separado se preferir, ou integrado)
    document.addEventListener('DOMContentLoaded', function() {
        const chatGptContainer = document.getElementById('gpt-chat-container');
        if (!chatGptContainer) { return; } // N√£o executa se o container n√£o existir
        const chatForm = document.getElementById('gpt-chat-form');
        const userInput = document.getElementById('gpt-user-message');
        const chatMessagesContainer = document.getElementById('gpt-chat-messages');
        const sendButton = document.getElementById('gpt-send-button');
        if (!chatForm || !userInput || !chatMessagesContainer || !sendButton) { return; }
        const sendButtonOriginalHTML = sendButton.innerHTML;

        function appendMessageToGPTChat(senderType, text, isError = false) {
            const messagesInnerWrapper = chatMessagesContainer.querySelector('div'); 
            if (!messagesInnerWrapper) return;
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('chat-message-container', senderType === 'user' ? 'user' : 'other');
            const senderNameDiv = document.createElement('div');
            senderNameDiv.classList.add('message-sender-name');
            senderNameDiv.textContent = senderType === 'user' ? "{{ request.user.first_name|default:request.user.email.split|first|capfirst|escapejs }}" : "Assistente IA W1";
            messageContainer.appendChild(senderNameDiv);
            const bubbleWrapper = document.createElement('div');
            bubbleWrapper.classList.add('message-bubble-wrapper');
            const contentP = document.createElement('p');
            contentP.classList.add('message-content'); contentP.innerText = text;
            bubbleWrapper.appendChild(contentP);
            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('message-timestamp-chat');
            const now = new Date();
            timestampSpan.textContent = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}, ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            bubbleWrapper.appendChild(timestampSpan);
            messageContainer.appendChild(bubbleWrapper);
            messagesInnerWrapper.appendChild(messageContainer);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
        chatForm.addEventListener('submit', async function(event) { 
            event.preventDefault();
            const messageText = userInput.value.trim();
            if (!messageText) return;
            appendMessageToGPTChat('user', messageText);
            userInput.value = '';
            userInput.disabled = true; sendButton.disabled = true; sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const response = await fetch("{% url 'chat_with_gpt' %}", {
                    method: 'POST', headers: { 'Content-Type': 'application/json', /* 'X-CSRFToken': '{{ csrf_token }}' */ },
                    body: JSON.stringify({ message: messageText })
                });
                const data = await response.json();
                if (response.ok && data.reply) { appendMessageToGPTChat('assistant', data.reply); } 
                else { appendMessageToGPTChat('assistant', data.error || 'Erro ao processar sua mensagem.', true); }
            } catch (error) { appendMessageToGPTChat('assistant', 'N√£o foi poss√≠vel conectar ao assistente.', true);
            } finally { userInput.disabled = false; sendButton.disabled = false; sendButton.innerHTML = sendButtonOriginalHTML; userInput.focus(); }
        });
    });
    </script>
{% endblock scripts %}