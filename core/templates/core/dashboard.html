{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Meu Painel - W1 Holding Platform{% endblock %}

{% block header %}
    <header class="dashboard-header">
        <div class="logo-container">
            <img src="{% static 'images/logo.png' %}" alt="W1 Logo">
            <h1>Bem-vindo, {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.email.split|first|capfirst }}{% endif %}!</h1>
        </div>
        <div class="header-right" style="display: flex; flex-direction: row;">
            <div class="search-container">
                <input type="text" class="search-bar" placeholder="Pesquisar...">
                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <span class="search-text">Buscar</span>
            </div>
            <div class="header-icons">
                <svg class="notification-icon" data-section="notificacoes" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" title="Notificações">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <svg class="settings-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" title="Configurações">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l-.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </div>
        </div>
    </header>
{% endblock header %}

{% block head_extra_styles %}
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { background-color: #022028 !important; color: #e5e7eb; font-family: 'Montserrat', sans-serif; margin: 0; overflow-x: hidden; }
        .cal-sans-regular { font-family: "Cal Sans", sans-serif; font-weight: 400; font-style: normal; }
        .dashboard-header { background: #011A21; border-bottom: solid 1px #000; color: #fff; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; width: 100%; z-index: 1050; height: 70px; }
        .logo-container { display: flex; align-items: center; }
        .logo-container img { max-height: 35px; margin-right: 12px; }
        .logo-container h1 { font-size: 1.2rem; font-family: "Cal Sans", sans-serif; color: #fff; margin: 0; }
        .search-container { display: flex; align-items: center; width: 280px; background: #044048; border: 1px solid #055058; border-radius: 4px; padding: 6px 10px; margin-right: 15px; }
        .search-bar { flex: 1; background: transparent; color: #d1d5db; border: none; outline: none; font-family: "Montserrat", sans-serif; font-size: 0.9rem; }
        .search-bar::placeholder { color: #6b7280; }
        .search-icon, .search-text { color: #d1d5db; margin-left: 8px; font-family: "Montserrat", sans-serif; }
        .search-text { font-size: 0.8rem; font-weight: bold; }
        .search-icon:hover, .search-text:hover, .notification-icon:hover, .settings-icon:hover { color: #5fded4; cursor: pointer; }
        .header-icons { display: flex; align-items: center; gap: 18px; }
        .header-icons svg { width: 22px; height: 22px; stroke: currentColor; }
        .dashboard-container { display: flex; background: #022028; padding-top: 70px; }
        .sidebar { width: 260px; background: #011a21; color: #fff; border-right: solid 1px #000; padding: 20px 0px 0px 0px; overflow-y: auto; height: calc(100vh - 70px); position: fixed; left: 0; top: 70px; z-index: 1000; }
        .sidebar ul { list-style-type: none; padding: 0; margin:0; }
        .sidebar-item { margin-bottom: 0px; border-radius: 0px; transition: background-color 0.2s ease; border-left: 3px solid transparent; }
        .sidebar-item:hover { background-color: #033038; }
        .sidebar-item a { color: #adb5bd; text-decoration: none; font-weight: 500; font-size: 0.95rem; font-family: "Montserrat", sans-serif; display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; transition: color 0.2s ease, border-left-color 0.2s ease; }
        .sidebar-item a:hover { color: #5fded4; }
        .sidebar-item.active { background-color: #044048; border-left-color: #5fded4; }
        .sidebar-item.active a { color: #5fded4; font-weight: 600; }
        .nav-icon-container { display: flex; align-items: center; gap: 12px; }
        .nav-icon-container svg { width: 18px; height: 18px; stroke: #adb5bd; fill:none; transition: stroke 0.2s ease; }
        .sidebar-item a:hover .nav-icon-container svg, .sidebar-item.active .nav-icon-container svg { stroke: #5fded4; }
        .sidebar-item a.logout-btn .nav-icon-container svg { stroke: #e57373; }
        .sidebar-item a.logout-btn:hover .nav-icon-container svg { stroke: #ef5350; }
        .main-content-wrapper { margin-left: 260px; width: calc(100% - 260px); background-color: #022028; padding: 25px; }
        .main-content { color: #fff; }
        .section { display: none; margin-bottom: 2rem; background-color: #022028; padding: 0px; border-radius: 8px;  animation: fadeInContent 0.5s ease-out; }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section.active { display: block; }
        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #044048; }
        .section-header h2 { font-size: 1.75rem; color: #fff; font-family: "Cal Sans", sans-serif; margin: 0; display: flex; align-items:center; }
        .section-header .fas { font-size: 1.5rem; color: #5fded4; margin-right: 10px; }
        .section-header svg.title-icon { width: 24px; height: 24px; stroke: #fff; fill:none; margin-right: 10px; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .progress-list, .document-list { display: flex; flex-wrap: wrap; gap: 20px; }
        .progress-card, .document-card { background: #044048; border: 1px solid #055058; border-radius: 8px; padding: 16px; margin-bottom: 16px; display: flex; align-items: center; width: calc(50% - 10px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.3s ease; }
         @media (max-width: 1024px) { .progress-card, .document-card { width: 100%; } }
        .progress-card:hover, .document-card:hover { transform: translateY(-2px); }
        .progress-icon, .document-icon { width: 40px; height: 40px; margin-right: 16px; flex-shrink: 0; }
        .progress-icon svg, .document-icon svg { width: 100%; height: 100%; stroke: #5fded4; fill: none; }
        .progress-card.incomplete .progress-icon svg, .document-card.incomplete .document-icon svg { stroke: #fff; fill: none; }
        .progress-content, .document-content { flex: 1; }
        .progress-title, .document-title { font-size: 1.25rem; color: #5fded4; font-family: "Cal Sans", sans-serif; margin: 0 0 8px; }
        .progress-card.incomplete .progress-title, .document-card.incomplete .document-title { color: #fff; }
        .progress-description, .document-description { font-size: 0.875rem; color: #d1d5db; font-family: "Montserrat", sans-serif; margin: 0 0 12px; }
        .progress-bar-container { background: #022028; border-radius: 4px; height: 8px; overflow: hidden; }
        .progress-bar { background: #5fded4; height: 100%; transition: width 0.3s ease; }
        .status-text { font-style: italic; font-size: 0.875rem; color: #d1d5db; }
        .status-text .fas, .progress-status .fas { color: #5fded4; }
        .status-text .text-green-400, .progress-status .text-green-400 { color: #34d399 !important; }
        .status-text .text-yellow-400, .progress-status .text-yellow-400 { color: #facc15 !important; }
        .progress-status { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 0.875rem; color: #d1d5db; }
        .progress-status .status-icon { color: #5fded4; }
        .document-upload .upload-btn { display: inline-block; padding: 8px 16px; background-color: #5fded4; color: #022028; border-radius: 4px; font-weight: bold; font-family: "Montserrat", sans-serif; text-decoration: none; cursor: pointer; transition: background-color 0.3s ease; font-size: 0.85rem; }
        .document-upload .upload-btn:hover { background-color: #4acbc1; }
        .ia-input { padding-top: 20px; }
        .ia-input textarea { width: 100%; height: 100px; padding: 10px; background: #044048; color: #d1d5db; border: 1px solid #055058; border-radius: 4px; font-family: "Montserrat", sans-serif; }
        .ia-input button, .chat-input button, .invite-btn.auth-btn { margin-top: 10px; padding: 10px 20px; background-color: #5fded4; color: #022028; border: none; border-radius: 4px; font-weight: bold; font-family: "Montserrat", sans-serif; cursor: pointer; }
        .ia-input button:hover, .chat-input button:hover, .invite-btn.auth-btn:hover { background-color: #4acbc1; }
        .table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #044048; color: #d1d5db; border-radius: 8px; overflow: hidden; }
        .table th, .table td { border: 1px solid #055058; padding: 10px; text-align: left; font-family: "Montserrat", sans-serif; }
        .table th { background: #055058; color: #5fded4; }
        .table a { color: #5fded4; text-decoration: underline; }
        .table a:hover { color: #7aded5; }
        .chat-window { border: 1px solid #055058; padding: 10px; min-height: 150px; overflow-y: auto; margin-bottom: 10px; background: #044048; color: #d1d5db; font-family: "Montserrat", sans-serif; border-radius: 4px; }
        .chat-input input { flex-grow: 1; padding: 10px; background: #044048; color: #d1d5db; border: 1px solid #055058; border-radius: 4px; font-family: "Montserrat", sans-serif; margin-right: 10px; }
        .chat-input { display: flex; }
        .sidebar-item a.logout-btn { background-color: transparent; color: #e57373; border: none; }
        .sidebar-item a.logout-btn:hover { background-color: rgba(227, 52, 52, 0.1); color: #ef5350; }
        .django-messages-container { padding: 0 25px 15px 25px; }
        @media (max-width: 768px) {
            .dashboard-header { height: auto; flex-direction: column; align-items: flex-start; padding: 10px; }
            .logo-container h1 { font-size: 1rem; }
            .header-right { width: 100%; margin-top: 10px; flex-direction: column; align-items: flex-start; }
            .search-container { width: 100%; margin-right: 0; margin-bottom:10px; }
            .header-icons { gap: 10px; }
            .dashboard-container { flex-direction: column; padding-top: 120px; } /* Ajustado para mais espaço do header responsivo */
            .sidebar { position: static; width: 100%; height: auto; border-right: none; border-bottom: solid 1px #000; padding: 10px 0; }
            .sidebar ul { display: flex; flex-wrap: wrap; justify-content: space-around;}
            .sidebar-item { width: 48%; margin-bottom: 5px;}
            .sidebar-item a { padding: 10px; font-size: 0.9rem; }
            .nav-icon-container svg { width: 16px; height: 16px; }
            .main-content-wrapper { margin-left: 0; width: 100%; padding: 15px; }
            .section { padding: 15px; }
            .section-header h2 { font-size: 1.5rem; }
            .progress-card, .document-card { width: 100%; flex-direction: column; align-items: flex-start;}
            .progress-icon, .document-icon { margin-bottom: 12px; }
        }
        /* Estilos para o formulário de upload de documentos no dashboard do cliente */
        .form-group-custom { margin-bottom: 1.5rem; }
        .form-group-custom label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #cbd5e1; font-size:0.9rem; }
        .form-control-custom { display: block; width: 100%; padding: .5rem .75rem; font-size: 1rem; font-weight: 400; line-height: 1.5; color: #cbd5e1; background-color: #044048; background-clip: padding-box; border: 1px solid #055058; -webkit-appearance: none; -moz-appearance: none; appearance: none; border-radius: .375rem; transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; }
        .form-control-custom:focus { color: #e5e7eb; background-color: #055058; border-color: #5fded4; outline: 0; box-shadow: 0 0 0 .2rem rgba(95, 222, 212, .25); }
        .form-control-custom::placeholder { color: #6b7280; }
        .form-control-custom[type="file"]::file-selector-button { padding: .5rem .75rem; margin: -.5rem -.75rem; margin-inline-end: .75rem; color: #022028; background-color: #5fded4; border-right: 1px solid #055058; border-top:0; border-left:0; border-bottom:0; border-radius: 0; transition: background-color .15s ease-in-out; }
        .form-control-custom[type="file"]::file-selector-button:hover { background-color: #4acbc1; }
        .submit-btn-custom { background-color: #5fded4; color: #022028; padding: 0.65rem 1.5rem; border-radius: 0.375rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; border: none; cursor: pointer; transition: background-color 0.2s, transform 0.1s; font-size: 0.9rem; }
        .submit-btn-custom:hover { background-color: #4acbc1; transform: translateY(-1px); }
        .error-messages-custom { background-color: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.5); color: #f87171; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1.5rem; font-size:0.9rem; }
        .error-messages-custom ul { list-style-position: inside; padding-left: 0.5rem; }
        .error-messages-custom li { margin-bottom: 0.25rem; }
        .text-red-400 { color: #f87171; } /* Tailwind like class for field errors */
        .text-gray-500 { color: #6b7280; }
        .text-xs { font-size: 0.75rem; }
        .mt-1 { margin-top: 0.25rem; }
        .db { display:block; } /* utility class for display block */

        .document-group-card { background-color: #043842; padding:1rem; border-radius:6px; }
        .document-group-card h5 { font-size: 1.1rem; color: #e5e7eb; margin-bottom: 0.75rem; font-family: "Cal Sans", sans-serif;}
        .document-group-card .document-card {
            background-color: #055058;
            border-left: 4px solid #076070; /* Borda padrão para versões mais antigas */
        }
        .document-group-card .document-card.latest-version {
            border-left-color: #5fded4; /* Borda de destaque para a versão mais recente */
            background-color: #065a68;
        }
        .document-group-card .document-card .document-title { font-size: 0.95rem; }
        .document-group-card .document-card .document-description { font-size: 0.8rem; }
        .document-group-card .upload-btn { font-size: 0.8rem; padding: 0.3rem 0.6rem; }

    </style>
{% endblock head_extra_styles %}

{% block content %}
<div class="dashboard-container">
    <nav class="sidebar">
        <ul>
            <li class="sidebar-item"><a href="#progresso"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>Progresso</div><span>&gt;</span></a></li>
            <li class="sidebar-item"><a href="#documentos"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M2 15h10"></path><path d="M9 18l3-3-3-3"></path></svg>Documentos</div><span>&gt;</span></a></li>
            <li class="sidebar-item"><a href="#socios"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>Sócios</div><span>&gt;</span></a></li>
            <li class="sidebar-item"><a href="#consultor"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>Consultor</div><span>&gt;</span></a></li>
            <li class="sidebar-item"><a href="#simulacao"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"></rect><rect x="8" y="6" width="8" height="2"></rect><line x1="8" y1="11" x2="16" y2="11"></line><line x1="8" y1="14" x2="16" y2="14"></line><line x1="8" y1="17" x2="16" y2="17"></line></svg>Simulação</div><span>&gt;</span></a></li>
            <li class="sidebar-item"><a href="#ia"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"></circle><path d="M16 8v5a3 3 0 0 0 6 0v-1a3 3 0 1 0-3-3"></path><path d="M8 16v-5a3 3 0 0 0-6 0v1a3 3 0 1 0 3 3"></path></svg>IA</div><span>&gt;</span></a></li>
            <li class="sidebar-item" style="margin-top: 20px; ">
                <a href="{% url 'account_logout' %}" id="logout" class="logout-btn"><div class="nav-icon-container"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>Sair</div><span>&gt;</span></a></li>
        </ul>
    </nav>
    <div class="main-content-wrapper">
        <main class="main-content">
            {% if messages %}
                <div class="django-messages-container">
                {% for message in messages %}
                    <div class="p-3 mb-3 rounded-md text-sm
                        {% if message.tags == 'success' %} bg-green-100 border border-green-400 text-green-700
                        {% elif message.tags == 'error' %} bg-red-100 border border-red-400 text-red-700
                        {% elif message.tags == 'warning' %} bg-yellow-100 border border-yellow-400 text-yellow-700
                        {% else %} bg-blue-100 border border-blue-400 text-blue-700 {% endif %}"
                        role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}

            <section id="progresso" class="section active">
                <div class="section-header">
                    <h2><svg class="title-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>Seu Progresso</h2>
                </div>
                <div class="progress-list">
                    <div class="progress-card">
                        <div class="progress-icon"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
                        <div class="progress-content">
                            <h3 class="progress-title">Cadastro</h3>
                            <p class="progress-description">Crie sua conta com informações básicas para começar o processo.</p>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: 100%;"></div></div>
                            <p class="status-text mt-2">100% Concluído <i class="fas fa-check-circle text-green-400"></i></p>
                        </div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"></rect><line x1="6" y1="9" x2="18" y2="9"></line><line x1="6" y1="14" x2="18" y2="14"></line></svg></div>
                        <div class="progress-content">
                            <h3 class="progress-title">Formulário de Simulação</h3>
                            <p class="progress-description">Preencha os detalhes para ver os benefícios de uma holding.</p>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: {{ latest_simulation|yesno:'100%,0%' }};"></div></div>
                            <p class="status-text mt-2">
                                {% if latest_simulation %}100% Concluído <i class="fas fa-check-circle text-green-400"></i>{% else %}Pendente <i class="fas fa-hourglass-half text-yellow-400"></i>{% endif %}
                                <br><a href="{% url 'dashboard' %}" class="text-teal-400 hover:underline text-sm">Fazer/Refazer Simulação</a>
                            </p>
                        </div>
                    </div>
                    <div class="progress-card {% if not user_holdings %}incomplete{% endif %}">
                        <div class="progress-icon"><svg viewBox="0 0 24 24" stroke="{% if user_holdings %}#5fded4{% else %}#fff{% endif %}"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div>
                        <div class="progress-content">
                            <h3 class="progress-title {% if not user_holdings %}text-white{% endif %}">Criação da Holding</h3>
                            <p class="progress-description">Preenchimento dos dados para o registro da sua holding.</p>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: {% if user_holdings %}100%{% else %}0%{% endif %};"></div></div>
                            <p class="status-text mt-2">
                                {% if user_holdings %}Concluído <i class="fas fa-check-circle text-green-400"></i>{% else %}Pendente <i class="fas fa-hourglass-half text-yellow-400"></i>{% endif %}
                                {% if not user_holdings and latest_simulation %}<br><a href="{% url 'create_holding' %}" class="text-teal-400 hover:underline text-sm">Iniciar Criação da Holding</a>{% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="progress-card incomplete"> {# Esta lógica de 'incomplete' precisaria de um campo no ProcessoHolding #}
                        <div class="progress-icon"><svg viewBox="0 0 24 24" stroke="#fff"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div>
                        <div class="progress-content">
                            <h3 class="progress-title">Documentação</h3>
                            <p class="progress-description">Envio dos documentos necessários para formalização.</p>
                            {# A barra de progresso aqui pode ser baseada na contagem de documentos enviados vs. esperados (lógica a definir) #}
                            <div class="progress-bar-container"><div class="progress-bar" style="width: {% if grouped_documents_cliente %}25%{% else %}0%{% endif %};"></div></div>
                            <p class="status-text mt-2">
                                {% if grouped_documents_cliente %}Em Andamento <i class="fas fa-tasks text-blue-400"></i>
                                {% else %}Pendente <i class="fas fa-hourglass-half text-yellow-400"></i>{% endif %}
                                <br><a href="#documentos" class="text-teal-400 hover:underline text-sm switch-section-link">Enviar/Ver Documentos</a>
                            </p>
                        </div>
                    </div>
                     <div class="progress-card incomplete"> {# Esta lógica de 'incomplete' precisaria de um campo no ProcessoHolding #}
                        <div class="progress-icon"><svg viewBox="0 0 24 24" stroke="#fff"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
                        <div class="progress-content">
                            <h3 class="progress-title">Interação com Consultor</h3>
                            <p class="progress-description">Converse com um especialista para alinhar os próximos passos.</p>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: 0%;"></div></div>
                            <p class="status-text mt-2">Pendente <i class="fas fa-hourglass-half text-yellow-400"></i></p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="documentos" class="section">
                <div class="section-header">
                    <h2><svg class="title-icon" viewBox="0 0 24 24"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M2 15h10"></path><path d="M9 18l3-3-3-3"></path></svg>Documentos da Sua Holding</h2>
                </div>
            
                {% if user_holdings %}
                    {% if active_holding_for_docs and target_processo_id %}
                        <div class="content-card mb-6" style="background-color: #044048; padding: 1.5rem; border-radius: 8px;">
                            <h4 class="text-xl cal-sans-regular text-teal-400 mb-1">Enviar Novo Documento</h4>
                            <p class="text-sm text-gray-400 mb-4">Para a holding: <strong>{{ active_holding_for_docs.nome_holding }}</strong></p>
                            
                            {% if document_form.non_field_errors %}
                                <ul class="error-messages-custom !mb-3">
                                    {% for error in document_form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                                </ul>
                            {% endif %}
    
                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                {% for field in document_form %}
                                    <div class="form-group-custom">
                                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        {{ field }} {# Widget já tem a classe form-control-custom via forms.py #}
                                        {% if field.help_text %}<small class="text-gray-500 text-xs mt-1 db">{{ field.help_text|safe }}</small>{% endif %}
                                        {% if field.errors %}<div class="text-red-400 text-sm mt-1">{{ field.errors|join:", " }}</div>{% endif %}
                                    </div>
                                {% endfor %}
                                <button type="submit" name="upload_document_cliente" class="submit-btn-custom mt-3">
                                    <i class="fas fa-upload mr-2"></i>Enviar Documento
                                </button>
                            </form>
                        </div>
            
                        <h4 class="text-xl cal-sans-regular text-teal-400 mb-3 mt-6">Seus Documentos Enviados</h4>
                        {% if grouped_documents_cliente %}
                            {% for group_key, group_data in grouped_documents_cliente.items %}
                                <div class="document-group-card mb-4"> {# Estilo definido em head_extra_styles #}
                                    <h5> 
                                        {{ group_data.nome_logico }} 
                                        <span class="text-sm text-teal-500">({{ group_data.categoria_display }})</span>
                                    </h5>
                                    <ul class="list-none p-0 space-y-2">
                                        {% for doc in group_data.versoes %}
                                        <li class="document-card !flex-row items-center justify-between p-3 {% if forloop.first %}latest-version{% endif %}" style="width:100%;">
                                            <div class="document-content flex-grow">
                                                <span class="document-title !text-sm {% if forloop.first %}!text-teal-300{% else %}!text-gray-300{% endif %}">
                                                    <i class="fas fa-file-alt mr-2"></i>
                                                    {{ doc.nome_original_arquivo|default:doc.arquivo.name|truncatechars:45 }}
                                                    <strong class="ml-1">(v{{ doc.versao }})</strong>
                                                    {% if forloop.first %}<span class="text-xs text-teal-400 ml-2">(Mais Recente)</span>{% endif %}
                                                </span>
                                                <p class="document-description !text-xs !text-gray-400 mb-0 mt-1">
                                                    Enviado por: {{ doc.enviado_por.get_full_name|default:"Você" }} em {{ doc.data_upload|date:"d/m/Y H:i" }}
                                                </p>
                                                {% if doc.descricao_adicional %}
                                                <p class="document-description !text-xs !text-gray-500 italic mt-1">Obs: {{ doc.descricao_adicional|truncatewords:15 }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="document-upload ml-3 flex-shrink-0">
                                                <a href="{{ doc.arquivo.url }}" target="_blank" class="upload-btn !py-1 !px-3 !text-xs" title="Ver/Baixar v{{doc.versao}}">
                                                    <i class="fas fa-eye mr-1"></i> Ver/Baixar
                                                </a>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="content-card"><p class="text-gray-400">Nenhum documento enviado ainda para o processo desta holding.</p></div>
                        {% endif %}
                    {% else %}
                         <div class="content-card"><p class="text-gray-400">Nenhum processo de holding ativo encontrado para envio de documentos. Por favor, inicie a criação de uma holding para prosseguir.</p></div>
                    {% endif %}
                {% else %}
                     <div class="content-card"><p class="text-gray-400">Você ainda não criou ou não está associado a nenhuma holding. <a href="{% url 'create_holding' %}" class="text-teal-400 hover:underline">Clique aqui para iniciar o processo.</a></p></div>
                {% endif %}
            </section>

            <section id="socios" class="section">
                <div class="section-header">
                    <h2><svg class="title-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>Sócios da Holding</h2>
                    {% if user_holdings.first %} {# Condição para mostrar o botão de convite #}
                        <a href="{% url 'invite_partners' %}" class="invite-btn auth-btn"><i class="fas fa-user-plus mr-1"></i> Convidar Sócio</a>
                    {% endif %}
                </div>
                {% if user_holdings %}
                    {% for holding in user_holdings %}
                        <div class="mb-6">
                            <h4 class="text-xl cal-sans-regular text-teal-400 mb-3">Holding: {{ holding.nome_holding }}</h4>
                            {% if holding.clientes.all|length > 1 %}
                            <table class="table">
                                <thead><tr><th>Nome do Sócio</th><th>E-mail</th></tr></thead>
                                <tbody>
                                {% for socio in holding.clientes.all %}
                                    {% if socio != request.user %}
                                    <tr>
                                        <td>{{ socio.get_full_name|default:"Nome não informado" }}</td>
                                        <td>{{ socio.email }}</td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p class="text-gray-400">Ainda não há outros sócios convidados para "{{holding.nome_holding}}".</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-400">Nenhuma holding criada para listar sócios.</p>
                {% endif %}
            </section>

            <section id="consultor" class="section">
                <div class="section-header">
                        <h2><svg class="title-icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>Seu(s) Consultor(es)</h2>
                </div>
                {% if active_holding_for_docs and active_holding_for_docs.consultores.all %} {# ### ALTERADO AQUI ### #}
                    <div class="progress-card" style="width: auto; max-width: 500px;">
                        <div class="progress-content">
                            <h3 class="progress-title">Consultor(es) Designado(s) para {{active_holding_for_docs.nome_holding}}</h3>
                            {% for consultor in active_holding_for_docs.consultores.all %} {# ### ALTERADO AQUI ### #}
                                <p class="progress-description"><strong>Nome:</strong> {{ consultor.get_full_name|default:"Não informado" }}</p>
                                <p class="progress-description"><strong>E-mail:</strong> {{ consultor.email }}</p>
                                {% if not forloop.last %}<hr class="my-2 border-gray-700">{% endif %} {# Adiciona uma linha entre consultores se houver mais de um #}
                            {% endfor %}
                            <p class="mt-3 progress-description">Entre em contato para tirar suas dúvidas e dar os próximos passos.</p>
                        </div>
                    </div>
                {% elif active_holding_for_docs %}
                    <p class="text-gray-400">Nenhum consultor atribuído à sua holding ({{ active_holding_for_docs.nome_holding }}) ainda. Em breve nossa equipe entrará em contato.</p>
                {% else %}
                    <p class="text-gray-400">Crie ou selecione uma holding para que um consultor seja designado.</p>
                {% endif %}
                <div class="chat-window mt-6"> <p>Mensagem do consultor: Olá, como posso ajudar?</p> </div>
                <div class="chat-input"> <input type="text" placeholder="Digite sua mensagem..."> <button>Enviar</button> </div>
            </section>

            <section id="notificacoes" class="section">
                <div class="section-header"><h2>Notificações</h2></div>
                <ul>
                    <li>Documento enviado - 17/05/2025 21:27</li>
                    <li>Novo sócio adicionado - 17/05/2025 21:28</li>
                </ul>
            </section>

            <section id="simulacao" class="section">
                <div class="section-header">
                    <h2><svg class="title-icon" viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"></rect><rect x="8" y="6" width="8" height="2"></rect><line x1="8" y1="11" x2="16" y2="11"></line><line x1="8" y1="14" x2="16" y2="14"></line><line x1="8" y1="17" x2="16" y2="17"></line></svg>Sua Última Simulação</h2>
                        <a href="{% url 'dashboard' %}" class="invite-btn auth-btn"><i class="fas fa-redo mr-1"></i> Nova Simulação</a>
                </div>
                {% if latest_simulation %}
                    <div class="progress-card" style="width: auto; max-width: 600px;">
                        <div class="progress-content">
                        <h3 class="progress-title">Resultados da Simulação de {{ latest_simulation.created_at|date:"d/m/Y H:i" }}</h3>
                        <ul class="list-disc list-inside text-gray-300 pl-5 space-y-1 document-description">
                            <li>Nº Propriedades: {{ latest_simulation.number_of_properties }}</li>
                            <li>Valor Total Imóveis: R$ {{ latest_simulation.total_property_value|floatformat:2|intcomma }}</li>
                            {% if latest_simulation.inventory_savings > 0 %}<li>Economia Inventário: R$ {{ latest_simulation.inventory_savings|floatformat:2|intcomma }}</li>{% endif %}
                            {% if latest_simulation.profit_savings > 0 %}<li>Economia Lucros: R$ {{ latest_simulation.profit_savings|floatformat:2|intcomma }}</li>{% endif %}
                            {% if latest_simulation.rental_savings > 0 %}<li>Economia Aluguéis: R$ {{ latest_simulation.rental_savings|floatformat:2|intcomma }}</li>{% endif %}
                            <li class="mt-2"><strong>Economia Total Estimada: R$ {{ latest_simulation.total_savings|floatformat:2|intcomma }}</strong></li>
                            {% if latest_simulation.number_of_heirs > 0 %}
                                <li class="mt-2">Tempo Economizado (Inventário): {{ latest_simulation.inventory_time_without }} meses</li>
                                <li>Risco de Conflito (Sem Holding): {{ latest_simulation.conflict_risk }}</li>
                            {% endif %}
                        </ul>
                        </div>
                    </div>
                {% else %}
                    <p class="text-gray-400">Nenhuma simulação realizada ainda. <a href="{% url 'dashboard' %}" class="text-teal-400 hover:underline">Clique aqui para fazer sua primeira simulação.</a></p>
                {% endif %}
            </section>

            <section id="ia" class="section">
                <div class="section-header"><h2><svg class="title-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"></circle><path d="M16 8v5a3 3 0 0 0 6 0v-1a3 3 0 1 0-3-3"></path><path d="M8 16v-5a3 3 0 0 0-6 0v1a3 3 0 1 0 3 3"></path></svg>Inteligência Artificial</h2></div>
                <div class="ia-input"> <textarea placeholder="Pergunte à IA..."></textarea> <button>Enviar</button> </div>
            </section>
        </main>
    </div>
</div>
{% endblock %}

{% block footer %}{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const sidebarLinks = document.querySelectorAll('.sidebar-item a');
        const sections = document.querySelectorAll('.main-content .section');
        const notificationIcon = document.querySelector('.notification-icon');
        const switchSectionLinks = document.querySelectorAll('.switch-section-link'); // Links para trocar de seção

        function showSection(targetId) {
            const cleanTargetId = targetId.startsWith('#') ? targetId.substring(1) : targetId;

            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === cleanTargetId) {
                    section.classList.add('active');
                }
            });

            sidebarLinks.forEach(link => {
                const linkHref = link.getAttribute('href');
                const linkDataSection = link.getAttribute('data-section');
                const parentLi = link.closest('.sidebar-item');

                if (parentLi) {
                    parentLi.classList.remove('active');
                    if ((linkHref && linkHref.substring(1) === cleanTargetId) || (linkDataSection && linkDataSection === cleanTargetId)) {
                        parentLi.classList.add('active');
                    }
                }
            });
        }

        sidebarLinks.forEach(link => {
            const href = link.getAttribute('href');
            if ((href && href.startsWith('#')) || link.hasAttribute('data-section')) {
                link.addEventListener('click', (e) => {
                    const targetIdFromHref = href && href.startsWith('#') ? href.substring(1) : null;
                    const targetIdFromData = link.getAttribute('data-section');
                    const targetId = targetIdFromData || targetIdFromHref;

                    if (targetId && targetId !== 'logout') {
                        e.preventDefault();
                        showSection(targetId);
                        if (targetIdFromHref) {
                                history.pushState(null, null, '#' + targetId);
                        }
                    } else if (targetId === 'logout'){
                        // Permite o comportamento padrão do link de logout
                        return;
                    }
                });
            }
        });
        
        switchSectionLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                const targetId = link.getAttribute('href').substring(1);
                if (targetId && document.getElementById(targetId)) {
                    e.preventDefault();
                    showSection(targetId);
                    history.pushState(null, null, '#' + targetId);
                    // Opcional: Rolar para o topo da seção
                    document.getElementById(targetId).scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });


        if (notificationIcon) {
            notificationIcon.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = notificationIcon.getAttribute('data-section');
                if (targetId) {
                    showSection(targetId);
                        history.pushState(null, null, '#' + targetId);
                }
            });
        }

        let initialSectionId = 'progresso'; // Seção padrão
        if (window.location.hash) {
            const hashId = window.location.hash.substring(1);
            if (document.getElementById(hashId)) { // Verifica se a seção no hash existe
                initialSectionId = hashId;
            }
        }
        
        // Garante que uma seção válida seja exibida no carregamento
        if (document.getElementById(initialSectionId)) {
            showSection(initialSectionId);
        } else if (sections.length > 0) { // Fallback para a primeira seção se a do hash/padrão não existir
            sections[0].classList.add('active');
            const firstSectionId = sections[0].id;
            showSection(firstSectionId); // Atualiza o item ativo na sidebar
        }
    });
    </script>
{% endblock scripts %}