{% extends 'management/management_base.html' %}
{% load static %}

{% block page_title_content %}{{ page_title }}{% endblock %}

{% block content %}
    <div class="user-details-header">
        <h2 style="font-family: 'Cal Sans', sans-serif; color: #022028;">{{ user_obj.get_full_name|default:user_obj.email }}</h2>
        <p><strong>E-mail:</strong> {{ user_obj.email }}</p>
        <p><strong>Tipo:</strong> <span class="badge type-{{ user_obj.user_type }}">{{ user_obj.get_user_type_display }}</span></p>
        <p><strong>Status:</strong> {% if user_obj.is_active %}<span class="badge status-active">Ativo</span>{% else %}<span class="badge status-inactive">Inativo</span>{% endif %}</p>
        <p><strong>Data de Cadastro:</strong> {{ user_obj.date_joined|date:"d/m/Y H:i" }}</p>
    </div>
    <hr>

    {% if user_obj.user_type == 'cliente' %}
        <section id="client-details">
            <h4>Detalhes do Cliente</h4>
            {% if client_profile %}
                <p><strong>Patrimônio Estimado:</strong> R$ {{ client_profile.patrimonio_total_estimado|default:"N/A" }}</p>
                <p><strong>Rendimentos Anuais Estimados:</strong> R$ {{ client_profile.rendimentos_estimados_anuais|default:"N/A" }}</p>
            {% else %}
                <p>Perfil do cliente não preenchido.</p>
            {% endif %}

            <h5 style="margin-top: 1.5rem;">Holdings Participadas</h5>
            {% if client_holdings %}
                <ul class="list-styled">
                    {% for holding in client_holdings %}
                    <li>
                        <strong><a href="{% url 'management_holding_detail' holding.id %}">{{ holding.nome_holding }}</a></strong>
                        (Consultor Responsável:
                        {% if holding.consultor_responsavel %}
                            <a href="{% if request.user.is_superuser %}{% url 'management_user_detail' holding.consultor_responsavel.id %}{% else %}#{% endif %}">
                                {{ holding.consultor_responsavel.get_full_name|default:holding.consultor_responsavel.email }}
                            </a>
                        {% else %}
                            <span class="text-muted">Nenhum</span>
                        {% endif %})
                        <br>
                        <small class="action-links">
                            {# Este link agora é o principal para todas as ações da holding #}
                            <a href="{% url 'management_holding_detail' holding.id %}" class="btn btn-sm btn-light"><i class="fas fa-cogs"></i> Ver Detalhes/Gerenciar Holding</a>
                            {# O link para editar dados básicos (nome/descrição/consultor) ainda é separado e acessível via superuser #}
                            {% if request.user.is_superuser %}
                            <a href="{% url 'management_assign_consultant_to_holding' holding.id %}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i> Editar Dados Básicos</a>
                            {% endif %}
                        </small>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">Nenhuma holding associada.</p>
            {% endif %}

            {# ... (restante da seção do cliente) ... #}
        </section>

    {% elif user_obj.user_type == 'consultor' %}
        <section id="consultant-details">
            <h4>Detalhes do Consultor</h4>
            <h5 style="margin-top: 1.5rem;">Holdings Assessoradas (onde é Consultor Responsável)</h5>
            {% if consultant_assigned_holdings %}
                <ul class="list-styled">
                    {% for holding in consultant_assigned_holdings %}
                    <li>
                        <strong><a href="{% url 'management_holding_detail' holding.id %}">{{ holding.nome_holding }}</a></strong>
                        <br/>Cliente(s) Principal(is):
                        {% for cliente_h in holding.clientes.all %}
                            <a href="{% url 'management_user_detail' cliente_h.id %}">{{ cliente_h.get_full_name|default:cliente_h.email }}</a>{% if not forloop.last %}, {% endif %}
                        {% empty %}
                            <span class="text-muted">Nenhum cliente associado diretamente.</span>
                        {% endfor %}
                        <br>
                        <small class="action-links">
                             <a href="{% url 'management_holding_detail' holding.id %}" class="btn btn-sm btn-light"><i class="fas fa-cogs"></i> Ver Detalhes/Gerenciar Holding</a>
                             {% if request.user.is_superuser %} {# Superuser também pode editar dados básicos #}
                             <a href="{% url 'management_assign_consultant_to_holding' holding.id %}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i> Editar Dados Básicos</a>
                             {% endif %}
                        </small>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">Nenhuma holding diretamente assessorada.</p>
            {% endif %}
        </section>
    {% elif user_obj.user_type == 'admin' %}
        {# ... (seção do admin) ... #}
    {% endif %}

    <hr style="margin-top: 2rem; margin-bottom: 1.5rem;">
    <a href="{% url 'management_list_users' %}" class="btn"><i class="fas fa-arrow-left"></i> Voltar para Lista de Usuários</a>

    {# ... (estilos) ... #}
{% endblock %}