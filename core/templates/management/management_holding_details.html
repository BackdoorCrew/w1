{% extends 'management/management_base.html' %}
{% load static %}
{% load humanize %}

{% block page_title_content %}{{ page_title|default:"Detalhes da Holding" }}{% endblock %}

{% block content %}
<div class="container-fluid holding-details-page px-lg-4">
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h2 page-title mb-0">{{ holding.nome_holding }}</h1>
            <div>
                {% if holding.is_legally_official %}
                    <span class="badge bg-success-soft text-success"><i class="fas fa-check-circle me-1"></i>Oficializada em {{ holding.data_oficializacao|date:"d/m/Y"|default:"Data não informada" }}</span>
                {% else %}
                    <span class="badge bg-warning-soft text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Pendente de Oficialização</span>
                {% endif %}
            </div>
        </div>
        {% if holding.description %}
            <p class="text-muted mt-1">{{ holding.description|linebreaksbr }}</p>
        {% endif %}
    </div>

    <div class="info-bar row g-2 mb-4">
        <div class="col-md-auto">
            <strong class="text-muted-strong">Consultores:</strong>
            {% if holding.consultores.all %}
                {% for consultor_obj in holding.consultores.all %}
                    <a href="{% if request.user.is_superuser %}{% url 'management_user_detail' consultor_obj.id %}{% else %}#{% endif %}" class="badge bg-primary-soft text-primary text-decoration-none me-1">{{ consultor_obj.get_full_name|default:consultor_obj.email }}</a>
                {% endfor %}
            {% else %}
                <span class="badge bg-danger-soft text-danger">Nenhum consultor.</span>
            {% endif %}
            {% if request.user.is_superuser %}
                <a href="{% url 'management_manage_holding_details_and_consultants' holding.id %}" class="btn btn-xs btn-outline-secondary ms-1 py-0 px-1" title="Editar Consultores"><i class="fas fa-edit fa-xs"></i></a>
            {% endif %}
        </div>
        <div class="col-md-auto"><strong class="text-muted-strong">Criação (Plataforma):</strong> {{ holding.processo_criacao.data_inicio_processo|date:"d/m/y H:i"|default_if_none:"N/A" }}</div>
        <div class="col-md-auto"><strong class="text-muted-strong">Registro (Junta/Cartório):</strong> {{ holding.data_criacao_registro|date:"d/m/y"|default_if_none:"Não informado" }}</div>
    </div>

    <div class="row">
        <div class="col-lg-7 mb-4">
            {# Características da Holding #}
            <div class="card shadow-sm">
                <div class="card-header bg-light border-bottom">
                    <h5 class="mb-0 card-title-strong"><i class="fas fa-list-alt me-2 text-primary"></i>Características da Holding <small class="text-muted fw-normal">(Informadas pelo Cliente)</small></h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        {% comment %} You would ideally put the content of management/partials/holding_characteristics_display.html here, or include it {% endcomment %}
                        {# Example of direct inclusion or content: #}
                        <div class="col-md-6 mb-3">
                            <strong class="text-muted-strong">Poupança/Dinheiro em Banco:</strong><br>
                            {% if holding.has_bank_savings %}
                                <i class="fas fa-check-circle text-success me-1"></i>Sim (R$ {{ holding.bank_savings_amount|default_if_none:"0.00"|intcomma }})
                            {% else %}
                                <i class="fas fa-times-circle text-danger me-1"></i>Não
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong class="text-muted-strong">Possui Herdeiros:</strong><br>
                            {% if holding.has_heirs %}
                                <i class="fas fa-check-circle text-success me-1"></i>Sim ({{ holding.heir_count|default_if_none:"N/A" }} herdeiro(s))
                            {% else %}
                                <i class="fas fa-times-circle text-danger me-1"></i>Não
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3"><strong class="text-muted-strong">Plano Sucessório Pensado:</strong><br>{{ holding.has_succession_plan|yesno:"Sim,Não,Não informado" }}</div>
                        <div class="col-md-6 mb-3"><strong class="text-muted-strong">Já Pagou Inventário:</strong><br>{{ holding.has_paid_inventory|yesno:"Sim,Não,Não informado" }}</div>
                        <div class="col-md-6 mb-3">
                            <strong class="text-muted-strong">Imóveis Alugados:</strong><br>
                            {% if holding.has_rental_properties %}
                                Sim ({{ holding.rental_property_count|default_if_none:"N/A" }} imóvel/is)
                                {% if holding.rental_income_monthly is not None %}<span class="d-block form-text">Renda Mensal: R$ {{ holding.rental_income_monthly|intcomma }}</span>{% endif %}
                                {% if holding.rental_expenses_monthly is not None %}<span class="d-block form-text">Despesas Mensais: R$ {{ holding.rental_expenses_monthly|intcomma }}</span>{% endif %}
                            {% else %}
                                Não
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3"><strong class="text-muted-strong">Receio de Ações Judiciais:</strong><br>{{ holding.has_litigation_concerns|yesno:"Sim,Não,Não informado" }}</div>
                        <div class="col-md-6 mb-3"><strong class="text-muted-strong">Problemas Legais/Setor de Risco:</strong><br>{{ holding.has_legal_issues|yesno:"Sim,Não,Não informado" }}</div>
                        <div class="col-md-6 mb-3"><strong class="text-muted-strong">Quer Proteger Patrimônio:</strong><br>{{ holding.wants_asset_protection|yesno:"Sim,Não,Não informado" }}</div>
                        {% if holding.protected_assets %}
                        <div class="col-12 mb-3">
                            <strong class="text-muted-strong">Bens a Proteger:</strong><br>{{ holding.protected_assets|linebreaksbr }}
                        </div>
                        {% endif %}
                        <div class="col-md-6 mb-3">
                            <strong class="text-muted-strong">Sócio de Empresas:</strong><br>
                            {% if holding.has_companies %}
                                Sim ({{ holding.company_count|default_if_none:"N/A" }} empresa(s))
                                {% if holding.company_profit_annual is not None %}<span class="d-block form-text">Lucro Anual: R$ {{ holding.company_profit_annual|intcomma }}</span>{% endif %}
                            {% else %}
                                Não
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3"><strong class="text-muted-strong">Distribui Lucros/Reinveste:</strong><br>{{ holding.distributes_profits|yesno:"Distribui,Reinveste,Não informado" }}</div>
                        <div class="col-md-6 mb-3"><strong class="text-muted-strong">Muitos Bens em Nome Próprio:</strong><br>{{ holding.has_multiple_assets|yesno:"Sim,Não,Não informado" }}</div>
                        <div class="col-md-6 mb-3"><strong class="text-muted-strong">Facilitar Gestão/Venda de Bens:</strong><br>{{ holding.wants_efficient_management|yesno:"Sim,Não,Não informado" }}</div>
                        <div class="col-md-6 mb-3"><strong class="text-muted-strong">Dificuldades com Controle Patrimonial:</strong><br>{{ holding.has_management_difficulties|yesno:"Sim,Não,Não informado" }}</div>

                    </div>
                    {% if request.user.is_superuser %}
                        <hr class="my-3">
                        <a href="{% url 'management_manage_holding_details_and_consultants' holding.id %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-pencil-alt me-1"></i> Editar Dados Básicos e Consultores
                        </a>
                    {% endif %}
                </div>
            </div>

            {# Status do Processo de Criação #}
            {% if processo_criacao %}
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light border-bottom">
                    <h5 class="mb-0 card-title-strong"><i class="fas fa-tasks me-2 text-info"></i>Status do Processo de Criação</h5>
                </div>
                <div class="card-body p-4">
                    <p><strong class="text-muted-strong">Status Atual:</strong> <span class="badge status-badge-{{ processo_criacao.status_atual }}">{{ processo_criacao.get_status_atual_display }}</span></p>
                    <p><strong class="text-muted-strong">Início do Processo:</strong> {{ processo_criacao.data_inicio_processo|date:"d/m/Y H:i" }}</p>
                    <p><strong class="text-muted-strong">Última Atualização:</strong> {{ processo_criacao.data_ultima_atualizacao|date:"d/m/Y H:i" }}</p>
                    {% if processo_criacao.observacoes %}
                        <p class="mb-1"><strong class="text-muted-strong">Observações Internas:</strong></p>
                        <pre class="form-text bg-light p-2 border rounded" style="white-space: pre-wrap; font-size: 0.9em;">{{ processo_criacao.observacoes }}</pre>
                    {% endif %}
                    {% if process_status_form and not holding.is_legally_official %}
                    <hr class="my-3">
                    <h6 class="mb-3 text-muted-strong">Atualizar Status do Processo</h6>
                    <form method="post" novalidate class="needs-validation">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="{{ process_status_form.status_atual.id_for_label }}" class="form-label">{{ process_status_form.status_atual.label }}</label>
                            {{ process_status_form.status_atual }}
                            {% if process_status_form.status_atual.errors %}<div class="invalid-feedback d-block">{{ process_status_form.status_atual.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ process_status_form.observacoes.id_for_label }}" class="form-label">{{ process_status_form.observacoes.label }}</label>
                            {{ process_status_form.observacoes }}
                            {% if process_status_form.observacoes.errors %}<div class="invalid-feedback d-block">{{ process_status_form.observacoes.errors|join:", " }}</div>{% endif %}
                        </div>
                        <button type="submit" name="update_status" class="btn btn-primary"><i class="fas fa-sync-alt me-1"></i>Atualizar Status</button>
                    </form>
                    {% elif holding.is_legally_official %}
                    <p class="mt-3 text-success"><i class="fas fa-info-circle me-1"></i>O processo é considerado finalizado pois a holding foi oficializada.</p>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning mt-4"><i class="fas fa-exclamation-triangle me-2"></i>Nenhum processo de criação formalmente iniciado para esta holding.</div>
            {% endif %}

            {# Oficializar Holding #}
            {% if not holding.is_legally_official and officialize_form %}
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light border-bottom">
                    <h5 class="mb-0 card-title-strong"><i class="fas fa-gavel me-2 text-success"></i>Oficializar Holding Legalmente</h5>
                </div>
                <div class="card-body p-4">
                    <p class="form-text">Ao marcar como oficializada, você confirma que a holding foi constituída conforme as leis e está pronta para operar.</p>
                    <form method="post" novalidate class="needs-validation">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="{{ officialize_form.data_oficializacao.id_for_label }}" class="form-label">{{ officialize_form.data_oficializacao.label }}</label>
                            {{ officialize_form.data_oficializacao }}
                            {% if officialize_form.data_oficializacao.errors %}<div class="invalid-feedback d-block">{{ officialize_form.data_oficializacao.errors|join:", " }}</div>{% endif %}
                        </div>
                        <button type="submit" name="officialize_holding" class="btn btn-success"><i class="fas fa-gavel me-1"></i>Marcar como Oficializada</button>
                    </form>
                </div>
            </div>
            {% elif holding.is_legally_official %}
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-success-soft border-success">
                    <h5 class="mb-0 card-title-strong text-success"><i class="fas fa-check-circle me-2"></i>Holding Oficializada</h5>
                </div>
                <div class="card-body p-4">
                    <p class="lead mb-2">Esta holding foi oficialmente constituída em <strong>{{ holding.data_oficializacao|date:"d \d\e F \d\e Y" }}</strong>.</p>
                    {% if request.user.is_superuser %}
                    <form method="post" onsubmit="return confirm('Tem certeza que deseja REVERTER a oficialização desta holding? Esta ação deve ser usada com cautela.');">
                        {% csrf_token %}
                        <button type="submit" name="un_officialize_holding" class="btn btn-sm btn-outline-danger"><i class="fas fa-undo me-1"></i>Reverter Oficialização</button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-5 mb-4">
            {# Clientes/Sócios #}
            <div class="card shadow-sm">
                <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 card-title-strong"><i class="fas fa-users me-2 text-purple"></i>Clientes/Sócios ({{ socios.count }})</h5>
                    <div>
                        <a href="{% url 'management_holding_manage_clients' holding.id %}" class="btn btn-sm btn-outline-secondary me-1" title="Gerenciar Clientes"><i class="fas fa-users-cog"></i></a>
                        <a href="{% url 'management_holding_chat' holding.id %}" class="btn btn-sm btn-outline-info" title="Chat da Holding"><i class="fas fa-comments"></i></a>
                    </div>
                </div>
                <ul class="list-group list-group-flush">
                    {% for socio in socios %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="{% if request.user.is_superuser or request.user in holding.consultores.all %}{% url 'management_user_detail' socio.id %}{% else %}#{% endif %}">{{ socio.get_full_name|default:socio.email }}</a>
                        {% if holding.processo_criacao and holding.processo_criacao.cliente_principal_id == socio.id %}<span class="badge bg-info-soft text-info">Cliente Principal</span>{% endif %}
                    </li>
                    {% empty %}<li class="list-group-item text-muted fst-italic">Nenhum cliente/sócio associado.</li>{% endfor %}
                </ul>
            </div>

            {# Documentos da Holding #}
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light border-bottom">
                    <h5 class="mb-0 card-title-strong"><i class="fas fa-folder-open me-2 text-orange"></i>Documentos da Holding ({{ documentos_holding_count }})</h5>
                </div>
                <div class="card-body p-3">
                    {% if processo_criacao %}
                        <div class="document-forms-container p-3 border bg-white rounded mb-3">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted-strong mb-2"><i class="fas fa-plus-circle text-success me-1"></i>Novo Documento</h6>
                                    <form method="post" enctype="multipart/form-data" action="{% url 'management_holding_detail' holding.id %}">
                                        {% csrf_token %}
                                        {{ management_document_form.as_p }}
                                        <button type="submit" name="upload_document_management" class="btn btn-sm btn-success w-100 mt-2"><i class="fas fa-upload me-1"></i>Enviar</button>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                     <h6 class="text-muted-strong mb-2"><i class="fas fa-folder-plus text-primary me-1"></i>Nova Pasta</h6>
                                    <form method="post" action="{% url 'management_holding_detail' holding.id %}">
                                        {% csrf_token %}
                                        {{ pasta_form_management.as_p }}
                                        <button type="submit" name="create_folder_management" class="btn btn-sm btn-primary w-100 mt-2"><i class="fas fa-folder-plus me-1"></i>Criar</button>
                                    </form>
                                </div>
                            </div>
                             {% if management_document_form.non_field_errors or pasta_form_management.non_field_errors %}
                                <div class="alert alert-danger mt-3 p-2 small">
                                    {% for error in management_document_form.non_field_errors %}<p class="mb-1">{{ error }}</p>{% endfor %}
                                    {% for error in pasta_form_management.non_field_errors %}<p class="mb-1">{{ error }}</p>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <h6 class="text-muted-strong mb-2 mt-3">Documentos e Pastas Existentes:</h6>
                        <div class="folder-tree-container p-2 border rounded bg-white" style="max-height: 400px; overflow-y: auto;">
                            {% if folder_structure_management or root_documents_management %}
                                {% with folders=folder_structure_management documents=root_documents_management user_is_management=True target_processo_id=processo_criacao.id pasta_creation_form=pasta_form_management depth=0 %}
                                    {% include "core/folder_tree_display.html" %}
                                {% endwith %}
                            {% else %}
                                <p class="text-muted fst-italic mb-0 p-2">Nenhum documento ou pasta neste processo.</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="alert alert-secondary" role="alert">
                           O processo de criação ainda não foi iniciado. Documentos não podem ser gerenciados.
                        </div>
                    {% endif %}
                </div>
            </div>

            {# Análise Econômica #}
            {% if analise %}
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light border-bottom">
                    <h5 class="mb-0 card-title-strong"><i class="fas fa-chart-line me-2 text-indigo"></i>Análise Econômica</h5>
                </div>
                <div class="card-body p-4">
                    <p><strong class="text-muted-strong">Ano de Referência:</strong> {{ analise.ano_referencia }}</p>
                    <p><strong class="text-muted-strong">Economia Estimada:</strong> R$ {{ analise.economia_tributaria_estimada|default_if_none:"N/A"|intcomma }}</p>
                    <p><strong class="text-muted-strong">Patrimônio Projetado:</strong> R$ {{ analise.patrimonio_liquido_projetado|default_if_none:"N/A"|intcomma }}</p>
                    <small class="text-muted">Cálculo de {{ analise.data_calculo|date:"d/m/Y" }}</small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% comment %}
    The 'holding_characteristics_display.html' partial was commented out in the previous response.
    I've included its content directly above for completeness this time.
    If you want to use it as a partial, create the file:
    /app/core/templates/management/partials/holding_characteristics_display.html
    and move the relevant characteristic divs into it, then use:
    {% include "management/partials/holding_characteristics_display.html" with holding=holding %}
{% endcomment %}

{% endblock %} {# This is the IMPORTANT closing tag for 'block content' #}

{% block extra_css %}
<style>
    .holding-details-page .page-header .page-title {
        font-family: 'Cal Sans', 'Inter', sans-serif;
        color: #212529; /* Darker color for better readability */
    }
    .info-bar { font-size: 0.85rem; }
    .info-bar .col-md-auto { padding-top: 0.3rem; padding-bottom: 0.3rem;}
    .text-muted-strong { color: #495057; font-weight: 500; }
    .card-title-strong { font-weight: 500; font-size: 1.1rem; color: #343a40;}
    .card-header { padding: 0.75rem 1.25rem; background-color: #f8f9fa; } /* Lighter card header */
    .card-body { font-size: 0.9rem; }
    .card-body .form-label { font-size: 0.85rem; font-weight: 500; color: #495057; }
    .card-body .form-control, .card-body .form-select { font-size: 0.9rem; }
    .card-body pre.form-text { font-size: 0.85em !important; background-color: #e9ecef; } /* Slightly darker for pre */
    .btn-xs { padding: 0.1rem 0.3rem; font-size: 0.7rem; }
    .fa-xs { font-size: 0.7em; }

    /* Badge Soft Colors */
    .badge.bg-success-soft { background-color: #d1e7dd; color: #0f5132 !important; }
    .badge.bg-warning-soft { background-color: #fff3cd; color: #664d03 !important; }
    .badge.bg-primary-soft { background-color: #cfe2ff; color: #084298 !important; }
    .badge.bg-danger-soft { background-color: #f8d7da; color: #58151c !important; }
    .badge.bg-info-soft { background-color: #cff4fc; color: #055160 !important; }

    /* Process Status Badges */
    .status-badge-aguardando_documentos { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5;}
    .status-badge-documentacao_em_analise { background-color: #cff4fc; color: #055160; border: 1px solid #b6effb;}
    .status-badge-elaboracao_contrato { background-color: #e2d9f3; color: #49258e; border: 1px solid #d1c5ec;} /* Custom purple */
    .status-badge-registro_junta { background-color: #ffe5d0; color: #853b00; border: 1px solid #ffd8b6;} /* Custom orange */
    .status-badge-providencias_pos_registro { background-color: #f7d6e6; color: #7d1f4b; border: 1px solid #f3c3da;} /* Custom pink */
    .status-badge-concluido { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc;}
    .status-badge-concluido_oficializado { background-color: #cfe2ff; color: #084298; border: 1px solid #b6d4fe;}
    .status-badge-cancelado { background-color: #f8d7da; color: #58151c; border: 1px solid #f1c2c7;}

    /* Card Icons Theming */
    .text-primary { color: #0d6efd !important; }
    .text-info { color: #0dcaf0 !important; }
    .text-success { color: #198754 !important; }
    .text-purple { color: #6f42c1 !important; }
    .text-orange { color: #fd7e14 !important; }
    .text-indigo { color: #6610f2 !important; }

    /* Simpler form rendering from as_p */
    .document-forms-container p { margin-bottom: 0.5rem; }
    .document-forms-container label { font-size: 0.8rem; font-weight: 500; color: #495057; display: block; margin-bottom: 0.2rem;}
    .document-forms-container input[type="text"],
    .document-forms-container input[type="file"],
    .document-forms-container select,
    .document-forms-container textarea {
        font-size: 0.85rem;
        padding: 0.3rem 0.5rem;
        width: 100%;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem; /* Add margin bottom to each field for spacing when using as_p */
    }
    .document-forms-container .form-text { font-size: 0.75rem; }
    /* .document-forms-container .btn { width: 100%; margin-top: 0.5rem;} */ /* Already has w-100 */

    .folder-tree-container {
        font-size: 0.9rem;
        background-color: #f8f9fa !important; /* Light background for the tree area */
    }
</style>
{% endblock %}